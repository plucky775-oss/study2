<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ì •ìš°ìŠ¤ì¼€ì¤„">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">
  <title>ì •ìš° í•™ì› ìŠ¤ì¼€ì¤„</title>
  <style>
    :root{
      --bg: #f4f6fb;
      --panel: #ffffff;
      --panel-2: #fbfbfd;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #d9deea;
      --border-2: #c7cfe3;
      --danger: #dc2626;

      --time-col: 86px;
      --cell-h: 66px;
      --header-h: 46px;

      --radius: 16px;
      --radius-sm: 12px;

      --shadow: 0 8px 30px rgba(15,23,42,.08);
      --shadow-sm: 0 4px 14px rgba(15,23,42,.10);

      --badge-bg: rgba(255,255,255,.82);
      --badge-border: rgba(15,23,42,.18);
      --badge-text: #0b1220;
      --badge-font: 14px;

      --grid-min-day: 92px; /* iPad í•œëˆˆì— ë³´ì´ë„ë¡ ìµœì†Œí­ ì¡°ì • */
    }
    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{ color: inherit; }
    button, input, select{
      font: inherit;
      font-size: 16px; /* iOS ìë™ í™•ëŒ€ ë°©ì§€ */
    }
    button{
      border: 1px solid var(--border);
      background: var(--panel);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      touch-action: manipulation;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity: .55;
      cursor: not-allowed;
    }
    input[type="text"]{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: var(--panel);
      outline: none;
    }
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: var(--panel);
      outline: none;
    }
    textarea{ resize: vertical; min-height: 92px; }
    select{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: var(--panel);
    }
    .wrap{
      max-width: 1260px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 32px;
    }
    header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      background: linear-gradient(180deg, #0f172a 0%, #111827 100%);
      color: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .titlebox{
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .title{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      font-size: 12px;
      color: rgba(255,255,255,.78);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .head-actions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .head-actions button{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.22);
      color: #fff;
      box-shadow: none;
    }

    .panel{
      margin-top: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow-sm);
    }
    .row{
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 10px 12px;
      align-items: center;
      padding: 10px 6px;
      border-top: 1px solid var(--border);
    }
    .row:first-child{ border-top: none; }
    .label{
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .row .field{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .seg{
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: var(--panel-2);
    }
    .seg button{
      border: none;
      border-right: 1px solid var(--border);
      border-radius: 0;
      padding: 10px 12px;
      background: transparent;
      color: var(--text);
      font-weight: 800;
    }
    .seg button:last-child{ border-right: none; }
    .seg button.on{
      background: #111827;
      color: #fff;
    }

    .toggle{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel-2);
      font-weight: 700;
      color: var(--text);
      user-select: none;
    }
    .toggle input{ transform: scale(1.1); }

    .palette{
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .colorbtn{
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 2px solid rgba(15,23,42,.20);
      padding: 0;
      position: relative;
    }
    .colorbtn.on::after{
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.95);
      box-shadow: 0 0 0 2px rgba(15,23,42,.25);
    }
    .colorpicker{
      width: 44px;
      height: 36px;
      padding: 0;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      overflow: hidden;
    }
    .colorpicker input{
      width: 100%;
      height: 100%;
      border: none;
      padding: 0;
      background: transparent;
    }

    .chips{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 8px 6px 2px;
    }
    .chip{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      cursor: pointer;
      user-select: none;
      font-weight: 800;
      font-size: 13px;
    }
    .chip .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.25);
      background: var(--c, #ddd);
    }
    .chip.on{
      border-color: rgba(15,23,42,.35);
      box-shadow: 0 0 0 3px rgba(15,23,42,.08);
      background: #fff;
    }


    .chipwrap{
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .chipdel{
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
    }
    .chipdel:active{ transform: translateY(1px); }

    .hint{
      padding: 6px 8px 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .hint b{ color: var(--text); }

    .grid-card{
      margin-top: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .grid-scroll{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(100vh - 430px);
    }

    .grid{
      display: grid;
      grid-template-columns: var(--time-col) repeat(7, minmax(var(--grid-min-day), 1fr));
      /* header + slots */
      grid-auto-rows: var(--cell-h);
      min-width: calc(var(--time-col) + 7 * var(--grid-min-day));
    }
    .th{
      height: var(--header-h);
      align-self: stretch;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #111827;
      background: #fff;
      border-bottom: 2px solid var(--border-2);
      border-right: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .th.timehead{
      left: 0;
      z-index: 7;
      border-right: 2px solid var(--border-2);
    }
    .th:last-child{ border-right: none; }

    .time{
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #111827;
      background: #fff;
      border-bottom: 1px solid var(--border);
      border-right: 2px solid var(--border-2);
      position: sticky;
      left: 0;
      z-index: 3;
    }
    .cell{
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      background: #fff;
      padding: 8px;
      position: relative;
      overflow: hidden;
    }
    .cell:last-child{ border-right: none; }

    .cellbtn{
      width: 100%;
      height: 100%;
      border: 2px solid rgba(15,23,42,.08); /* ë” ì„ ëª…í•œ í…Œë‘ë¦¬ */
      border-radius: 16px; /* ë¸”ë¡ ë‘¥ê¸€ê²Œ */
      padding: 8px;
      background: transparent;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 6px;
      position: relative;
      overflow: hidden;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: none;
    }
    .cellbtn.filled{
      border-color: rgba(15,23,42,.18);
      box-shadow: 0 6px 16px rgba(15,23,42,.10);
    }
    .cellbtn.anchor{
      outline: 3px solid rgba(17,24,39,.25);
      outline-offset: 0px;
    }
    .cellbtn.conflict{
      outline: 3px solid rgba(220,38,38,.55);
      outline-offset: 0px;
    }
    .labels{
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
      pointer-events: none;
    }
    .badge{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
      max-width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--badge-border);
      background: var(--badge-bg);
      color: var(--badge-text);
      font-weight: 900;
      font-size: var(--badge-font);
      line-height: 1;
      box-shadow: 0 3px 12px rgba(15,23,42,.10);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge small{
      font-size: 11px;
      font-weight: 900;
      color: rgba(15,23,42,.65);
    }

    .bottom{
      margin-top: 12px;
      display: grid;
      gap: 12px;
    }
    .lists{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .listbox{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 12px;
      min-width: 0;
    }
    .listbox h3{
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 900;
    }
    .entry{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel-2);
      margin-bottom: 8px;
    }
    .entry:last-child{ margin-bottom: 0; }
    .entry .left{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .entry .topline{
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      font-weight: 900;
      font-size: 13px;
    }
    .entry .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.25);
      background: var(--c, #ddd);
      flex: 0 0 auto;
    }
    .entry .meta{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .entry .actions{
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .entry .actions button{
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-size: 12px;
      background: #fff;
    }
    .danger{
      border-color: rgba(220,38,38,.35) !important;
      color: var(--danger);
    }

    .hidden{ display: none !important; }
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      line-height: 1;
    }
    .pill.due{
      border-color: rgba(220,38,38,.35);
      color: var(--danger);
      background: rgba(220,38,38,.06);
    }
    .pill.ok{
      border-color: rgba(16,185,129,.35);
      color: #047857;
      background: rgba(16,185,129,.08);
    }
    .pill.wait{
      border-color: rgba(245,158,11,.35);
      color: #92400e;
      background: rgba(245,158,11,.10);
    }
    .muted{ color: var(--muted); }
    .kpis{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .kpi{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel-2);
      font-weight: 900;
      font-size: 12px;
    }
    .kpi b{ font-size: 13px; }

    .two-col{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .two-col{ grid-template-columns: 1fr; }
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.96);
      color: #fff;
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
    .toast button{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.20);
      color: #fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
    }

    .locked .panel, .locked .chips{
      opacity: .80;
    }
    .locked .panel input, .locked .panel select, .locked .panel button, .locked .chips{
      /* ì ê¸ˆ ì¤‘ì—ë„ ìŠ¤í¬ë¡¤/ë³´ê¸°ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ, í¸ì§‘ ë²„íŠ¼ì€ ë¹„í™œì„±í™” */
    }

    @media (max-width: 980px){
      .lists{ grid-template-columns: 1fr; }
      .grid-scroll{ max-height: calc(100vh - 520px); }
    }

    /* ì¸ì‡„ í˜ì´ì§€ ì„¤ì • */
    @page{ size: A4 landscape; margin: 8mm; }

    @media print{
      /* í•œì¥ì— ê½‰ ì°¨ê²Œ: A4 ê°€ë¡œ + ì»´íŒ©íŠ¸ ë ˆì´ì•„ì›ƒ */

      :root{
        --time-col: 72px;
        --cell-h: 44px;
        --header-h: 32px;
        --grid-min-day: 80px;
        --badge-font: 10px;
        --radius: 0px;
        --radius-sm: 0px;
      }

      body{ background: #fff; }
      header, .panel, .toast{ display: none !important; }
      .wrap{ max-width: none; padding: 0; }
      .print-only{ display: block !important; }
      .grid-card{ border: none; box-shadow: none; }
      .grid-scroll{ max-height: none; overflow: visible; }

      /* ëª©ë¡ì€ ê¸¸ì–´ì§€ë©´ ì—¬ëŸ¬ ì¥ìœ¼ë¡œ ë„˜ì–´ê°€ë¯€ë¡œ: ì¸ì‡„ì—ì„œëŠ” ì‹œê°„í‘œ(ê·¸ë¦¬ë“œ)ë§Œ í•œ ì¥ ì¶œë ¥ */
      #timetableLists{ display: none !important; }

      /* stickyëŠ” ì¸ì‡„ì—ì„œ ê¹¨ì§ˆ ìˆ˜ ìˆì–´ ë¹„í™œì„±í™” */
      .th, .time{ position: static !important; }

      /* ê·¸ë¦¬ë“œ/ë°°ì§€ ì»´íŒ©íŠ¸ */
      .grid{ min-width: 0 !important; width: 100% !important; }
      .cell{ padding: 4px; }
      .cellbtn{ border-radius: 10px; padding: 4px; }
      .badge{ padding: 3px 6px; font-size: var(--badge-font); }
      .badge .sub{ font-size: 9px; }
      .th{ font-size: 12px; }
      .time{ font-size: 11px; }

      /* í˜ì´ì§€ ë¶„í•  ë°©ì§€(ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´) */
      .grid-card, .grid{ break-inside: avoid; page-break-inside: avoid; }
    }

    .print-only{ display: none; }
    .print-head{
      padding: 0 0 8px;
      margin: 0 0 8px;
      border-bottom: 1px solid #d9deea;
    }
    .print-title{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -.2px;
    }
    .print-meta{
      margin-top: 4px;
      font-size: 11px;
      color: #334155;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titlebox">
        <div class="title">ì •ìš° í•™ì› ìŠ¤ì¼€ì¤„</div>
        <div class="subtitle" id="subtitle">09:00 ~ 22:00 Â· ì •ê·œë°˜/ë‚´ì‹ ë°˜ ë¹„êµ</div>
      </div>
      <div class="head-actions">
        <button id="lockBtn" type="button">ğŸ”“ ì ê¸ˆ í•´ì œ</button>
        <button id="printBtn" type="button">ğŸ–¨ï¸ ì¸ì‡„/PDF</button>
      </div>
    </header>

    <section class="panel" id="controlPanel">
      <div class="row">
        <div class="label">ë©”ë‰´</div>
        <div class="field">
          <div class="seg" id="tabSeg">
            <button type="button" data-tab="timetable">ì‹œê°„í‘œ</button>
            <button type="button" data-tab="payments">ê²°ì œ</button>
            <button type="button" data-tab="makeup">ë³´ê°•</button>
          </div>
          <div class="kpis" id="kpiBar" style="margin-left:6px;"></div>
        </div>
      </div>

      <div class="row">
        <div class="label">í•™ê¸°</div>
        <div class="field">
          <select id="profileSelect"></select>
          <button id="newProfileBtn" type="button">+ ìƒˆ í•™ê¸°</button>
          <button id="renameProfileBtn" type="button">ì´ë¦„ë³€ê²½</button>
          <button id="deleteProfileBtn" type="button" class="danger">ì‚­ì œ</button>
        </div>
      </div>

      <div class="row timetable-only">
        <div class="label">ë³´ê¸°</div>
        <div class="field">
          <div class="seg" id="viewSeg">
            <button type="button" data-view="compare">ë¹„êµ</button>
            <button type="button" data-view="regular">ì •ê·œë°˜</button>
            <button type="button" data-view="naesin">ë‚´ì‹ ë°˜</button>
          </div>
          <label class="toggle"><input id="preventOverlap" type="checkbox">ê²¹ì¹¨ ë°©ì§€</label>
          <label class="toggle"><input id="autoColor" type="checkbox">ê³¼ëª© ìë™ìƒ‰</label>
        </div>
      </div>

      <div class="row timetable-only">
        <div class="label">í¸ì§‘</div>
        <div class="field">
          <div class="seg" id="planSeg">
            <button type="button" data-plan="regular">ì •ê·œë°˜</button>
            <button type="button" data-plan="naesin">ë‚´ì‹ ë°˜</button>
          </div>
          <div class="seg" id="toolSeg">
            <button type="button" data-tool="paint">ì¹ í•˜ê¸°</button>
            <button type="button" data-tool="erase">ì§€ìš°ê¸°</button>
          </div>
          <span class="hint" id="lockHint" style="padding:0; margin-left:6px;"></span>
        </div>
      </div>

      <div class="row timetable-only">
        <div class="label">ê³¼ëª©/ìƒ‰ìƒ</div>
        <div class="field" style="min-width:0;">
          <input id="subjectInput" type="text" placeholder="ê³¼ëª©ëª… ì…ë ¥ (ì˜ˆ: êµ­ì–´)" style="flex:1; min-width:220px;" />
          <div class="palette" id="palette"></div>
          <div class="colorpicker" title="ìƒ‰ìƒ ì§ì ‘ ì„ íƒ"><input id="colorPicker" type="color" value="#1e88e5"></div>
        </div>
      </div>

      <div class="chips timetable-only" id="subjectChips"></div>

      <div class="hint timetable-only" id="hintLine">
        <b>ì‚¬ìš©ë²•:</b> ì¹¸ì„ ëˆ„ë¥´ë©´ ì¹ í•´ì§‘ë‹ˆë‹¤. ê°™ì€ ìš”ì¼ì—ì„œ <b>ì‹œì‘ì¹¸ â†’ ëì¹¸</b>ìœ¼ë¡œ ëˆ„ë¥´ë©´ êµ¬ê°„ì´ í•œ ë²ˆì— ì±„ì›Œì§‘ë‹ˆë‹¤. (ê²¹ì¹¨ ë°©ì§€ ONì´ë©´ ì¶©ëŒì€ ìë™ ì°¨ë‹¨)
      </div>
    </section>

    <!-- ê²°ì œ íƒ­ -->
    <section class="panel hidden" id="paymentsView">
      <div class="row">
        <div class="label">ì•Œë¦¼</div>
        <div class="field">
          <button id="notifPermBtn" type="button">ğŸ”” ì•Œë¦¼ ê¶Œí•œ</button>
          <button id="icsExportBtn" type="button">ğŸ“… ìº˜ë¦°ë” ì•Œë¦¼ ì¶”ê°€(.ics)</button>
          <span class="hint" id="notifHint" style="padding:0;"></span>
        </div>
      </div>
      <div class="row">
        <div class="label">ìƒˆ ê²°ì œ</div>
        <div class="field" style="min-width:0;">
          <input id="payName" type="text" placeholder="í•™ì›/ìˆ˜ì—…ëª… (ì˜ˆ: â—‹â—‹ìˆ˜í•™)" style="flex:1; min-width:200px;" />
          <input id="paySubject" type="text" placeholder="ê³¼ëª© (ì˜ˆ: ìˆ˜í•™)" style="width:160px;" />
          <input id="payFee" type="number" inputmode="numeric" placeholder="ê¸ˆì•¡" style="width:120px;" />
          <select id="payMethod" title="ê²°ì œë°©ë²•" style="width:140px;">
            <option value="transfer">ê²°ì œ: ê³„ì¢Œì´ì²´</option>
            <option value="auto">ê²°ì œ: ìë™ì´ì²´</option>
            <option value="card">ê²°ì œ: ì¹´ë“œ</option>
            <option value="mobile">ê²°ì œ: ê°„í¸ê²°ì œ</option>
            <option value="cash">ê²°ì œ: í˜„ê¸ˆ</option>
            <option value="etc">ê²°ì œ: ê¸°íƒ€</option>
          </select>
          <input id="payBank" type="text" placeholder="ì€í–‰(ì„ íƒ)" style="width:140px;" />
          <input id="payAccount" type="text" inputmode="numeric" placeholder="ê³„ì¢Œë²ˆí˜¸(ì„ íƒ)" style="width:220px;" />
          <select id="payDay" title="ê²°ì œì¼">
            <option value="">ê²°ì œì¼(ì¼)</option>
          </select>
          <select id="payRemind" title="ì•Œë¦¼">
            <option value="3,0">ì•Œë¦¼: 3ì¼ì „+ë‹¹ì¼</option>
            <option value="7,3,0">ì•Œë¦¼: 7ì¼ì „+3ì¼ì „+ë‹¹ì¼</option>
            <option value="1,0">ì•Œë¦¼: 1ì¼ì „+ë‹¹ì¼</option>
            <option value="0">ì•Œë¦¼: ë‹¹ì¼ë§Œ</option>
            <option value="">ì•Œë¦¼ ì—†ìŒ</option>
          </select>
          <input id="payTime" type="time" value="09:00" title="ì•Œë¦¼ ì‹œê°„" />
          <button id="payAddBtn" type="button">+ ì¶”ê°€</button>
        </div>
      </div>

      <div class="two-col">
        <div class="listbox" style="margin-top:10px;">
          <h3>ì´ë²ˆë‹¬ ê²°ì œ</h3>
          <div id="payListThis"></div>
        </div>
        <div class="listbox" style="margin-top:10px;">
          <h3>ë‹¤ìŒ ê²°ì œ(ì˜ˆì •)</h3>
          <div id="payListNext"></div>
        </div>
      </div>
    </section>

    <!-- ë³´ê°• íƒ­ -->
    <section class="panel hidden" id="makeupView">
      <div class="row">
        <div class="label">ìƒˆ ë³´ê°•</div>
        <div class="field" style="min-width:0;">
          <select id="mkAcademy"></select>
          <input id="mkSubject" type="text" placeholder="ê³¼ëª©" style="width:140px;" />
          <input id="mkDate" type="date" />
          <input id="mkStart" type="time" value="19:00" />
          <input id="mkEnd" type="time" value="21:00" />
          <select id="mkStatus">
            <option value="requested">ìš”ì²­ë¨(ë¯¸í™•ì •)</option>
            <option value="scheduled">í™•ì •ë¨(ì¼ì •)</option>
            <option value="done">ì™„ë£Œ</option>
            <option value="canceled">ì·¨ì†Œ</option>
          </select>
          <select id="mkRemindMin" title="ì•Œë¦¼">
            <option value="60">ì•Œë¦¼: 1ì‹œê°„ ì „</option>
            <option value="120">ì•Œë¦¼: 2ì‹œê°„ ì „</option>
            <option value="1440">ì•Œë¦¼: ì „ë‚ </option>
            <option value="0">ì•Œë¦¼: ì—†ìŒ</option>
          </select>
          <button id="mkAddBtn" type="button">+ ì¶”ê°€</button>
        </div>
      </div>

      <div class="two-col">
        <div class="listbox" style="margin-top:10px;">
          <h3>ë³´ê°• ëŒ€ê¸°í•¨</h3>
          <div id="mkListPending"></div>
        </div>
        <div class="listbox" style="margin-top:10px;">
          <h3>ë³´ê°• ì¼ì •</h3>
          <div id="mkListUpcoming"></div>
        </div>
      </div>
      <div class="listbox" style="margin-top:12px;">
        <h3>ì™„ë£Œ/ì·¨ì†Œ</h3>
        <div id="mkListDone"></div>
      </div>
    </section>

    <!-- ì¸ì‡„/PDF ì „ìš© í—¤ë”(í‰ì†Œì—ëŠ” ìˆ¨ê¹€) -->
    <div class="print-only print-head" id="printHeader">
      <div class="print-title" id="printTitle">ì •ìš° í•™ì› ìŠ¤ì¼€ì¤„</div>
      <div class="print-meta" id="printMeta"></div>
    </div>

    <section class="grid-card" id="timetableView">
      <div class="grid-scroll" id="gridScroll">
        <div class="grid" id="grid" aria-label="ì£¼ê°„ ì‹œê°„í‘œ"></div>
      </div>
    </section>

    <section class="bottom" id="timetableLists">
      <div class="lists">
        <div class="listbox">
          <h3>ì •ê·œë°˜ ì‹œê°„í‘œ</h3>
          <div id="listRegular"></div>
        </div>
        <div class="listbox">
          <h3>ë‚´ì‹ ë°˜ ì‹œê°„í‘œ</h3>
          <div id="listNaesin"></div>
        </div>
        <div class="listbox">
          <h3>ê²¹ì¹˜ëŠ” ì‹œê°„(ì¶©ëŒ)</h3>
          <div id="listConflicts"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"><span id="toastText"></span> <button id="toastBtn" type="button" style="display:none;"></button></div>

  <script>
  (function(){
    "use strict";

    // ====== Constants ======
    const START_MIN = 9 * 60;   // 09:00
    const END_MIN   = 22 * 60;  // 22:00 (exclusive)
    const dayNames = ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];

    const PRESET = [
      { key:"red",    label:"ë¹¨ê°•",  value:"#e53935" },
      { key:"orange", label:"ì£¼í™©",  value:"#fb8c00" },
      { key:"yellow", label:"ë…¸ë‘",  value:"#fdd835" },
      { key:"green",  label:"ì´ˆë¡",  value:"#43a047" },
      { key:"blue",   label:"íŒŒë‘",  value:"#1e88e5" },
      { key:"indigo", label:"ë‚¨ìƒ‰",  value:"#3949ab" },
      { key:"violet", label:"ë³´ë¼",  value:"#8e24aa" }
    ];

    // localStorage í‚¤ëŠ” ìœ ì§€(ê¸°ì¡´ ë°ì´í„° ë³´ì¡´). ë‚´ë¶€ ë²„ì „ë§Œ v5ë¡œ í™•ì¥.
    const STORAGE_KEY = "jw-academy-schedule-v4";
    const APP_VERSION = 6;

    // ====== Utilities ======
    const $ = (sel) => document.querySelector(sel);
    const escapeHtml = (s) => (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const pad2 = (n) => String(n).padStart(2,"0");
    const minToTime = (m) => `${pad2(Math.floor(m/60))}:${pad2(m%60)}`;
    const slotCount = (slotMin) => Math.floor((END_MIN - START_MIN) / slotMin);
    const slotStartMin = (slotIndex, slotMin) => START_MIN + slotIndex * slotMin;
    const slotKey = (day, slot) => `${day}-${slot}`;
    const otherPlan = (plan) => plan === "regular" ? "naesin" : "regular";
    const nowStamp = () => new Date().toISOString();

    function uid(){
      // short unique id
      return Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
    }

    function hashToIndex(str, mod){
      let h = 0;
      for(let i=0;i<str.length;i++){
        h = (h * 31 + str.charCodeAt(i)) >>> 0;
      }
      return h % mod;
    }

    function normalizeSubject(s){
      return (s||"").trim().replace(/\s+/g," ");
    }

    // í•œê¸€ IME ì¡°í•©(ì…ë ¥ ì¤‘) ê°’ì´ "ê³¼ëª©"ìœ¼ë¡œ ì €ì¥ë˜ë©´ì„œ
    // ã„±/êµ¬/êµ­/êµ­ã…‡/ìˆ˜í•˜ ê°™ì€ ì¤‘ê°„ê°’ ì¹©ì´ ìƒê¸°ëŠ” ë¬¸ì œ ë°©ì§€ìš© í•„í„°
    function hasCompatJamo(s){
      // í˜¸í™˜ ìëª¨(ã„±-ã…, ã…-ã…£)ê°€ í¬í•¨ë˜ë©´ ì¡°í•© ì¤‘ê°„ê°’ì¼ í™•ë¥ ì´ ë§¤ìš° ë†’ìŒ
      return /[ã„±-ã…ã…-ã…£]/.test(s||"");
    }

    function isValidSubjectName(subject){
      const s = normalizeSubject(subject);
      if(!s) return false;
      if(hasCompatJamo(s)) return false;
      // ê³¼ëª©ëª…ì€ ë³´í†µ 2ê¸€ì ì´ìƒ(êµ­ì–´/ìˆ˜í•™/ì˜ì–´/ê³¼í•™...).
      // 1ê¸€ì(êµ­/ìˆ˜/ì˜/ã…‡/ã……/...)ëŠ” ì¡°í•© ì¤‘ê°„ê°’ì¼ ê°€ëŠ¥ì„±ì´ ë†’ì•„ í‘œì‹œ/ì €ì¥ì„ ë§‰ëŠ”ë‹¤.
      if(s.length < 2) return false;
      return true;
    }

    function filterCompleteSubjects(subjects){
      const arr = Array.from(new Set((subjects||[]).map(normalizeSubject).filter(Boolean)));

      // 1) í™•ì‹¤íˆ ì¡°í•© ì¤‘ê°„ê°’ì¸ íŒ¨í„´ ì œê±°(ìëª¨ í¬í•¨/ë„ˆë¬´ ì§§ìŒ)
      let filtered = arr.filter(isValidSubjectName);

      // 2) ë°›ì¹¨ì´ ë¹ ì§„ ì¡°í•© ì¤‘ê°„ê°’ ì œê±° (ì˜ˆ: "ìˆ˜í•˜" -> "ìˆ˜í•™")
      //    NFDë¡œ ë¶„í•´í–ˆì„ ë•Œ, ë” ê¸´ ê³¼ëª©ëª…ì´ "ì§§ì€ ê³¼ëª©ëª… + (ë°›ì¹¨ 1ê¸€ì)" í˜•íƒœë©´
      //    ì§§ì€ ìª½ì€ ì¡°í•© ì¤‘ê°„ê°’ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ìˆ¨ê¸´ë‹¤.
      const nfdList = filtered.map(s => ({ s, nfd: s.normalize("NFD") }));
      filtered = filtered.filter(s => {
        const snfd = s.normalize("NFD");
        return !nfdList.some(o => {
          if(o.s === s) return false;
          if(!o.nfd.startsWith(snfd)) return false;
          if(o.nfd.length !== snfd.length + 1) return false;
          const extra = o.nfd.slice(-1);
          // ì¢…ì„±(ë°›ì¹¨) ìëª¨ ì˜ì—­
          return /[\u11A8-\u11FF]/.test(extra);
        });
      });

      return filtered.sort((a,b) => a.localeCompare(b, "ko"));
    }

    // ====== Date/Money helpers (ê²°ì œ/ë³´ê°•) ======
    function startOfDay(d){
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    function toYMD(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function parseYMD(s){
      if(!s) return null;
      const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return null;
      const y = parseInt(m[1],10);
      const mo = parseInt(m[2],10)-1;
      const da = parseInt(m[3],10);
      const d = new Date(y, mo, da);
      if(d.getFullYear()!==y || d.getMonth()!==mo || d.getDate()!==da) return null;
      return d;
    }
    function ymKey(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    }
    function parseTimeHHMM(s, fallback="09:00"){
      const v = (s || fallback || "09:00").trim();
      const m = v.match(/^(\d{1,2}):(\d{2})$/);
      if(!m) return {hh:9, mm:0};
      let hh = Math.min(23, Math.max(0, parseInt(m[1],10)));
      let mm = Math.min(59, Math.max(0, parseInt(m[2],10)));
      return {hh, mm};
    }
    function dueDateForMonth(payDay, year, monthIndex0, timeStr="09:00"){
      const day = Math.max(1, Math.min(31, parseInt(payDay,10) || 1));
      const last = new Date(year, monthIndex0+1, 0).getDate();
      const dd = Math.min(day, last);
      const t = parseTimeHHMM(timeStr, "09:00");
      return new Date(year, monthIndex0, dd, t.hh, t.mm, 0, 0);
    }
    function daysDiff(a, b){
      // a,b: Date -> (b-a) in days (midnight ê¸°ì¤€)
      const da = startOfDay(a).getTime();
      const db = startOfDay(b).getTime();
      return Math.round((db - da) / 86400000);
    }
    function ddayLabel(diffDays){
      if(diffDays === 0) return "D-DAY";
      if(diffDays > 0) return `D-${diffDays}`;
      return `ì—°ì²´ ${Math.abs(diffDays)}ì¼`;
    }
    function fmtMoney(n){
      const v = Number(n);
      if(!Number.isFinite(v)) return "-";
      return v.toLocaleString("ko-KR");
    }
    function safeInt(v, fallback=null){
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : fallback;
    }

    // ====== Payment helpers (ê²°ì œë°©ë²•/ê³„ì¢Œ) ======
    function payMethodLabel(code){
      const c = String(code||"").trim().toLowerCase();
      if(c === "transfer") return "ê³„ì¢Œì´ì²´";
      if(c === "auto") return "ìë™ì´ì²´";
      if(c === "card") return "ì¹´ë“œ";
      if(c === "mobile") return "ê°„í¸ê²°ì œ";
      if(c === "cash") return "í˜„ê¸ˆ";
      if(c === "etc") return "ê¸°íƒ€";
      return ""; // ë¯¸ì§€ì •
    }

    function parsePayMethodInput(raw, fallback=""){
      const s = String(raw||"").trim().toLowerCase();
      if(!s) return fallback;
      if(["transfer","auto","card","mobile","cash","etc"].includes(s)) return s;
      if(s.includes("ê³„ì¢Œ")) return "transfer";
      if(s.includes("ìë™")) return "auto";
      if(s.includes("ì¹´ë“œ")) return "card";
      if(s.includes("ê°„í¸") || s.includes("í˜ì´") || s.includes("pay")) return "mobile";
      if(s.includes("í˜„ê¸ˆ")) return "cash";
      if(s.includes("ê¸°íƒ€")) return "etc";
      return fallback;
    }

    function formatBankAccount(bank, account){
      const b = String(bank||"").trim();
      const a = String(account||"").trim().replace(/\s+/g, "");
      if(!b && !a) return "";
      if(b && a) return `${b} ${a}`;
      return a || b;
    }

    // ====== State ======
    const defaultProfile = () => ({
      id: uid(),
      name: "1í•™ê¸°",
      regular: {},   // slotKey -> {subject, color}
      naesin: {},    // slotKey -> {subject, color}
      subjectColors: {}, // subject -> color
      // ê²°ì œ/ë³´ê°• ê´€ë¦¬
      academies: [], // [{id,name,subject,fee,payDay,payMethod,bank,account,remindDays[],remindTime,createdAt,updatedAt}]
      paymentHistory: {}, // academyId -> {"YYYY-MM": {paidAt, amount}}
      makeups: [], // [{id, academyId, subject, date, start, end, status, remindMin, memo, createdAt, updatedAt}]
      updatedAt: nowStamp()
    });

    const defaultState = () => ({
      version: APP_VERSION,
      profiles: [ defaultProfile() ],
      activeProfileId: null,
      settings: {
        slotMinutes: 60,
        tab: "timetable", // timetable | payments | makeup
        viewMode: "compare",   // compare | regular | naesin
        activePlan: "regular", // regular | naesin
        tool: "paint",         // paint | erase
        preventOverlap: true,
        autoColor: true,
        locked: false
      },
      ui: {
        subject: "",
        color: PRESET[4].value,
        anchor: null // {day, slot} for range fill
      },
      meta: {
        // ì•±ì´ ì¼œì ¸ìˆëŠ” ë™ì•ˆì˜ "ë¡œì»¬ ì•Œë¦¼" ì¤‘ë³µ ë°©ì§€
        fired: {} // key -> iso timestamp
      }
    });

    let state = loadState();
    if(!state.activeProfileId){
      state.activeProfileId = state.profiles[0].id;
    }

    // ====== DOM ======
    const subtitleEl = $("#subtitle");
    const lockBtn = $("#lockBtn");
    const printBtn = $("#printBtn");

    // print header
    const printTitle = $("#printTitle");
    const printMeta = $("#printMeta");

    const profileSelect = $("#profileSelect");
    const newProfileBtn = $("#newProfileBtn");
    const renameProfileBtn = $("#renameProfileBtn");
    const deleteProfileBtn = $("#deleteProfileBtn");

    const tabSeg = $("#tabSeg");
    const kpiBar = $("#kpiBar");

    const paymentsView = $("#paymentsView");
    const makeupView = $("#makeupView");
    const timetableView = $("#timetableView");
    const timetableLists = $("#timetableLists");

    // payments
    const notifPermBtn = $("#notifPermBtn");
    const icsExportBtn = $("#icsExportBtn");
    const notifHint = $("#notifHint");
    const payName = $("#payName");
    const paySubject = $("#paySubject");
    const payFee = $("#payFee");
    const payMethod = $("#payMethod");
    const payBank = $("#payBank");
    const payAccount = $("#payAccount");
    const payDay = $("#payDay");
    const payRemind = $("#payRemind");
    const payTime = $("#payTime");
    const payAddBtn = $("#payAddBtn");
    const payListThis = $("#payListThis");
    const payListNext = $("#payListNext");

    // makeup
    const mkAcademy = $("#mkAcademy");
    const mkSubject = $("#mkSubject");
    const mkDate = $("#mkDate");
    const mkStart = $("#mkStart");
    const mkEnd = $("#mkEnd");
    const mkStatus = $("#mkStatus");
    const mkRemindMin = $("#mkRemindMin");
    const mkAddBtn = $("#mkAddBtn");
    const mkListPending = $("#mkListPending");
    const mkListUpcoming = $("#mkListUpcoming");
    const mkListDone = $("#mkListDone");

    const viewSeg = $("#viewSeg");
    const planSeg = $("#planSeg");
    const toolSeg = $("#toolSeg");

    const preventOverlapCb = $("#preventOverlap");
    const autoColorCb = $("#autoColor");

    const subjectInput = $("#subjectInput");
    const paletteEl = $("#palette");
    const colorPicker = $("#colorPicker");

    const subjectChips = $("#subjectChips");
    const lockHint = $("#lockHint");

    const gridScroll = $("#gridScroll");
    const gridEl = $("#grid");
    const listRegular = $("#listRegular");
    const listNaesin = $("#listNaesin");
    const listConflicts = $("#listConflicts");

    const toastEl = $("#toast");
    const toastText = $("#toastText");
    const toastBtn = $("#toastBtn");

    const cellMap = new Map(); // slotKey -> button element

    // subject input IME composing flag (í•œê¸€ ì¡°í•© ì¤‘)
    let subjectComposing = false;

    // ====== Storage ======
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const data = JSON.parse(raw);
        // minimal migration
        if(!data || typeof data !== "object") return defaultState();
        if(!Array.isArray(data.profiles) || data.profiles.length === 0) return defaultState();
        if(!data.settings) data.settings = defaultState().settings;
        if(!data.ui) data.ui = defaultState().ui;
        if(!data.meta) data.meta = defaultState().meta;
        if(!data.meta.fired) data.meta.fired = {};

        // ìƒˆ íƒ­/ê´€ë¦¬ ê¸°ëŠ¥ ê¸°ë³¸ê°’
        if(!data.settings.tab) data.settings.tab = "timetable";

        data.version = APP_VERSION;
        // ensure fields
        for(const p of data.profiles){
          p.regular = p.regular || {};
          p.naesin = p.naesin || {};
          p.subjectColors = p.subjectColors || {};
          p.academies = Array.isArray(p.academies) ? p.academies : [];
          // v6: ê²°ì œë°©ë²•/ê³„ì¢Œì •ë³´ í•„ë“œ ë³´ê°•
          for(const a of p.academies){
            if(!a || typeof a !== "object") continue;
            if(a.payMethod === undefined) a.payMethod = "";
            if(a.bank === undefined) a.bank = "";
            if(a.account === undefined) a.account = "";
          }
          p.paymentHistory = p.paymentHistory && typeof p.paymentHistory === "object" ? p.paymentHistory : {};
          p.makeups = Array.isArray(p.makeups) ? p.makeups : [];
          p.updatedAt = p.updatedAt || nowStamp();
          if(!p.id) p.id = uid();
          if(!p.name) p.name = "í•™ê¸°";
        }
        if(!data.activeProfileId) data.activeProfileId = data.profiles[0].id;
        return data;
      }catch(e){
        console.warn("loadState failed", e);
        return defaultState();
      }
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(e){
        console.warn("saveState failed", e);
        showToast("ì €ì¥ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ì €ì¥ê³µê°„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    function activeProfile(){
      return state.profiles.find(p => p.id === state.activeProfileId) || state.profiles[0];
    }

    function planMap(plan){
      const p = activeProfile();
      return plan === "regular" ? p.regular : p.naesin;
    }

    function updateProfileStamp(){
      const p = activeProfile();
      p.updatedAt = nowStamp();
    }

    // ====== Payments / Makeups (profile scoped) ======
    function academies(){
      const p = activeProfile();
      p.academies = Array.isArray(p.academies) ? p.academies : [];
      return p.academies;
    }
    function paymentHistory(){
      const p = activeProfile();
      p.paymentHistory = p.paymentHistory && typeof p.paymentHistory === "object" ? p.paymentHistory : {};
      return p.paymentHistory;
    }
    function makeups(){
      const p = activeProfile();
      p.makeups = Array.isArray(p.makeups) ? p.makeups : [];
      return p.makeups;
    }

    function findAcademyById(id){
      return academies().find(a => a.id === id) || null;
    }

    function isPaid(academyId, ym){
      const hist = paymentHistory();
      return !!(hist[academyId] && hist[academyId][ym]);
    }
    function markPaid(academyId, ym, amount){
      const hist = paymentHistory();
      hist[academyId] = hist[academyId] || {};
      hist[academyId][ym] = { paidAt: nowStamp(), amount: Number(amount) };
      updateProfileStamp();
      saveState();
    }
    function unmarkPaid(academyId, ym){
      const hist = paymentHistory();
      if(hist[academyId] && hist[academyId][ym]){
        delete hist[academyId][ym];
        updateProfileStamp();
        saveState();
      }
    }

    function nextUnpaidDue(academy, refDate=new Date()){
      if(!academy || !academy.payDay) return null;
      const hist = paymentHistory()[academy.id] || {};
      let y = refDate.getFullYear();
      let m = refDate.getMonth();
      for(let i=0;i<24;i++){
        const due = dueDateForMonth(academy.payDay, y, m, academy.remindTime || "09:00");
        const ym = ymKey(due);
        if(!hist[ym]){
          return { due, ym };
        }
        m += 1;
        if(m > 11){ m = 0; y += 1; }
      }
      return null;
    }

    function makeupStartDate(mk){
      if(!mk || !mk.date) return null;
      const d = parseYMD(mk.date);
      if(!d) return null;
      const t = parseTimeHHMM(mk.start || "00:00", "00:00");
      return new Date(d.getFullYear(), d.getMonth(), d.getDate(), t.hh, t.mm, 0, 0);
    }

    // ====== Toast ======
    let toastTimer = null;
    function showToast(msg, actionText=null, actionFn=null){
      toastText.textContent = msg;
      if(actionText && actionFn){
        toastBtn.style.display = "";
        toastBtn.textContent = actionText;
        toastBtn.onclick = () => { actionFn(); hideToast(); };
      }else{
        toastBtn.style.display = "none";
        toastBtn.onclick = null;
      }
      toastEl.classList.add("show");
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(hideToast, 2600);
    }
    function hideToast(){
      toastEl.classList.remove("show");
    }

    // ====== Color helpers ======
    function getSubjectColor(subject){
      const p = activeProfile();
      const map = p.subjectColors || {};
      const subj = normalizeSubject(subject);
      if(map[subj]) return map[subj];
      // êµ¬ë²„ì „ ë°ì´í„°(ê³µë°± í¬í•¨ ë“±) í˜¸í™˜
      if(subject && subject !== subj && map[subject]) return map[subject];
      return null;
    }
    function setSubjectColor(subject, color){
      const p = activeProfile();
      const subj = normalizeSubject(subject);
      // ì¡°í•© ì¤‘ê°„ê°’(ã„±/êµ¬/êµ­ã…‡/...)ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ
      if(!isValidSubjectName(subj)) return;
      p.subjectColors = p.subjectColors || {};
      p.subjectColors[subj] = color;
      updateProfileStamp();
      saveState();
    }
    function autoPickColor(subject){
      const idx = hashToIndex(subject, PRESET.length);
      return PRESET[idx].value;
    }

    // ====== Render controls ======
    function syncControls(){
      const p = activeProfile();

      // tab
      const tab = state.settings.tab || "timetable";
      for(const btn of tabSeg.querySelectorAll("button")){
        btn.classList.toggle("on", btn.dataset.tab === tab);
      }

      const hideTimetable = tab !== "timetable";
      for(const el of document.querySelectorAll(".timetable-only")){
        el.classList.toggle("hidden", hideTimetable);
      }
      timetableView.classList.toggle("hidden", hideTimetable);
      timetableLists.classList.toggle("hidden", hideTimetable);
      paymentsView.classList.toggle("hidden", tab !== "payments");
      makeupView.classList.toggle("hidden", tab !== "makeup");
      printBtn.disabled = tab !== "timetable";

      // subtitle
      if(tab === "timetable"){
        const vm = state.settings.viewMode;
        const vmText = vm === "compare" ? "ì •ê·œë°˜/ë‚´ì‹ ë°˜ ë¹„êµ" : (vm === "regular" ? "ì •ê·œë°˜ ë³´ê¸°" : "ë‚´ì‹ ë°˜ ë³´ê¸°");
        subtitleEl.textContent = `09:00 ~ 22:00 Â· ${p.name} Â· ${vmText}`;
      }else if(tab === "payments"){
        subtitleEl.textContent = `${p.name} Â· ê²°ì œ/ì•Œë¦¼ ê´€ë¦¬`;
      }else if(tab === "makeup"){
        subtitleEl.textContent = `${p.name} Â· ë³´ê°• ê´€ë¦¬`;
      }else{
        subtitleEl.textContent = `${p.name}`;
      }

      // lock
      document.body.classList.toggle("locked", !!state.settings.locked);
      lockBtn.textContent = state.settings.locked ? "ğŸ”’ ì ê¸ˆ" : "ğŸ”“ ì ê¸ˆ í•´ì œ";
      lockHint.textContent = state.settings.locked ? "ì ê¸ˆ ì¤‘: í¸ì§‘ ë¶ˆê°€" : "";

      // profile select
      profileSelect.innerHTML = "";
      for(const prof of state.profiles){
        const opt = document.createElement("option");
        opt.value = prof.id;
        opt.textContent = prof.name;
        if(prof.id === state.activeProfileId) opt.selected = true;
        profileSelect.appendChild(opt);
      }

      // segments
      for(const btn of viewSeg.querySelectorAll("button")){
        btn.classList.toggle("on", btn.dataset.view === state.settings.viewMode);
      }
      for(const btn of planSeg.querySelectorAll("button")){
        btn.classList.toggle("on", btn.dataset.plan === state.settings.activePlan);
      }
      for(const btn of toolSeg.querySelectorAll("button")){
        btn.classList.toggle("on", btn.dataset.tool === state.settings.tool);
      }

      preventOverlapCb.checked = !!state.settings.preventOverlap;
      autoColorCb.checked = !!state.settings.autoColor;

      // inputs
      subjectInput.value = state.ui.subject;
      colorPicker.value = state.ui.color;

      // disable while locked (keep print/lock available)
      const disabled = !!state.settings.locked;
      for(const el of [
        profileSelect, newProfileBtn, renameProfileBtn, deleteProfileBtn,
        ...viewSeg.querySelectorAll("button"),
        ...planSeg.querySelectorAll("button"),
        ...toolSeg.querySelectorAll("button"),
        preventOverlapCb, autoColorCb,
        subjectInput, colorPicker,
        ...paletteEl.querySelectorAll("button"),
      ]){
        if(!el) continue;
        // allow view change even when locked? user said click ì´ë™ ë¶ˆí¸, lock for viewing. We'll disable most edits, but allow view change.
      }

      // In locked mode: disable editing-related controls only, allow view change + print + lock
      const editDisable = (el) => { if(el){ el.disabled = disabled; } };
      editDisable(profileSelect);
      editDisable(newProfileBtn);
      editDisable(renameProfileBtn);
      editDisable(deleteProfileBtn);
      // allow viewSeg even locked for viewing
      for(const b of planSeg.querySelectorAll("button")) b.disabled = disabled;
      for(const b of toolSeg.querySelectorAll("button")) b.disabled = disabled;
      preventOverlapCb.disabled = disabled;
      autoColorCb.disabled = disabled;
      subjectInput.disabled = disabled;
      colorPicker.disabled = disabled;
      for(const b of paletteEl.querySelectorAll("button")) b.disabled = disabled;

      // ê²°ì œ/ë³´ê°• ì…ë ¥ì€ ì ê¸ˆ ì‹œ ë¹„í™œì„±í™”
      for(const el of [
        payName, paySubject, payFee, payMethod, payBank, payAccount, payDay, payRemind, payTime, payAddBtn,
        mkAcademy, mkSubject, mkDate, mkStart, mkEnd, mkStatus, mkRemindMin, mkAddBtn
      ]){
        if(el) el.disabled = disabled;
      }

      // chips: disable in lock
      for(const c of subjectChips.querySelectorAll("button")) c.disabled = disabled;
    }

    function updateNotifHint(){
      if(!notifHint) return;
      if(!("Notification" in window)){
        notifHint.textContent = "ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        return;
      }
      const p = Notification.permission;
      if(p === "granted"){
        notifHint.textContent = "ì•Œë¦¼: í—ˆìš©ë¨ (ì•±ì„ ì¼œë‘ë©´ ê²°ì œ/ë³´ê°• ì•Œë¦¼ì„ ë„ì›ë‹ˆë‹¤)";
      }else if(p === "denied"){
        notifHint.textContent = "ì•Œë¦¼: ì°¨ë‹¨ë¨ (ë¸Œë¼ìš°ì €/ì„¤ì •ì—ì„œ í—ˆìš©ìœ¼ë¡œ ë³€ê²½ í•„ìš”)";
      }else{
        notifHint.textContent = "ì•Œë¦¼: ë¯¸ì„¤ì • (ë²„íŠ¼ì„ ëˆŒëŸ¬ í—ˆìš©í•´ì£¼ì„¸ìš”)";
      }
    }

    function renderKpiBar(){
      if(!kpiBar) return;
      const p = activeProfile();
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();

      // unpaid this month
      let unpaidThis = 0;
      let nearest = null; // {due, label}
      for(const a of academies()){
        if(!a.payDay) continue;
        const dueThis = dueDateForMonth(a.payDay, y, m, a.remindTime || "09:00");
        const ym = ymKey(dueThis);
        const paid = isPaid(a.id, ym);
        if(!paid) unpaidThis++;

        const next = nextUnpaidDue(a, now);
        if(next){
          if(!nearest || next.due < nearest.due){
            nearest = { due: next.due };
          }
        }
      }

      // makeups
      const mks = makeups();
      const pending = mks.filter(x => (x.status === "requested") || (!x.date && x.status !== "done" && x.status !== "canceled")).length;
      const upcoming = mks.filter(x => {
        if(x.status !== "scheduled") return false;
        const sd = makeupStartDate(x);
        if(!sd) return true;
        return sd >= startOfDay(now);
      }).length;

      const parts = [];
      parts.push(`<span class="kpi">ğŸ’³ ë¯¸ê²°ì œ <b>${unpaidThis}</b></span>`);
      if(nearest){
        const dd = ddayLabel(daysDiff(now, nearest.due));
        parts.push(`<span class="kpi">ğŸ“… ë‹¤ìŒ ê²°ì œ <b>${escapeHtml(dd)}</b></span>`);
      }
      if(pending > 0){
        parts.push(`<span class="kpi">ğŸ§© ë³´ê°•ëŒ€ê¸° <b>${pending}</b></span>`);
      }else{
        parts.push(`<span class="kpi">ğŸ§© ë³´ê°• <b>${upcoming}</b></span>`);
      }
      kpiBar.innerHTML = parts.join("");
    }

    // ====== Build palette + chips ======
    function buildPalette(){
      paletteEl.innerHTML = "";
      for(const c of PRESET){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "colorbtn";
        b.title = c.label;
        b.style.background = c.value;
        b.dataset.color = c.value;
        b.addEventListener("click", () => {
          if(state.settings.locked) return;
          state.ui.color = c.value;
          colorPicker.value = c.value;
          // if subject exists, treat manual pick as subject color assignment
          const subj = normalizeSubject(state.ui.subject);
          if(isValidSubjectName(subj)){
            setSubjectColor(subj, c.value);
            showToast(`"${subj}" ìƒ‰ìƒ ì €ì¥`);
          }
          saveState();
          renderAll();
        });
        paletteEl.appendChild(b);
      }
    }

    function collectAllSubjects(){
      const p = activeProfile();
      const set = new Set();
      for(const k in p.regular){
        const s = p.regular[k]?.subject;
        if(s) set.add(normalizeSubject(s));
      }
      for(const k in p.naesin){
        const s = p.naesin[k]?.subject;
        if(s) set.add(normalizeSubject(s));
      }
      // include subjectColors keys
      for(const s in (p.subjectColors||{})){
        set.add(normalizeSubject(s));
      }
      return Array.from(set).filter(Boolean);
    }

    function collectKnownSubjects(){
      // "ì™„ì„±ëœ ê³¼ëª©ëª…"ë§Œ ë…¸ì¶œ
      return filterCompleteSubjects(collectAllSubjects());
    }

    function collectHiddenSubjects(){
      const all = collectAllSubjects();
      const visible = new Set(filterCompleteSubjects(all));
      return all.filter(s => s && !visible.has(s)).sort((a,b) => a.localeCompare(b, "ko"));
    }

    function _deleteSubjectFromProfile(p, subject){
      const subj = normalizeSubject(subject);
      let removedRegular = 0;
      let removedNaesin = 0;
      let removedColor = false;

      for(const k of Object.keys(p.regular || {})){
        const item = p.regular[k];
        if(item && normalizeSubject(item.subject) === subj){
          delete p.regular[k];
          removedRegular++;
        }
      }
      for(const k of Object.keys(p.naesin || {})){
        const item = p.naesin[k];
        if(item && normalizeSubject(item.subject) === subj){
          delete p.naesin[k];
          removedNaesin++;
        }
      }
      if(p.subjectColors){
        for(const k of Object.keys(p.subjectColors)){
          if(normalizeSubject(k) === subj){
            delete p.subjectColors[k];
            removedColor = true;
          }
        }
      }
      return { removedRegular, removedNaesin, removedColor };
    }

    function deleteSubjectEverywhere(subject, opts={render:true}){
      const subj = normalizeSubject(subject);
      if(!subj) return { removedRegular:0, removedNaesin:0, removedColor:false };
      const p = activeProfile();
      const res = _deleteSubjectFromProfile(p, subj);

      // clear current selection if needed
      if(normalizeSubject(state.ui.subject) === subj){
        state.ui.subject = "";
        subjectInput.value = "";
      }
      state.ui.anchor = null;

      if(opts.render){
        updateProfileStamp();
        saveState();
        renderAll();
      }
      return res;
    }

    function cleanupHiddenSubjects(){
      const hidden = collectHiddenSubjects();
      if(hidden.length === 0) return;
      const preview = hidden.slice(0, 6).join(", ") + (hidden.length > 6 ? " â€¦" : "");
      const ok = confirm(`ë¯¸ì™„ì„±/ì˜¤íƒ€ ê³¼ëª© ${hidden.length}ê°œë¥¼ ì •ë¦¬í• ê¹Œìš”?
(${preview})

â€» ì´ ê³¼ëª©ìœ¼ë¡œ ì¹ í•´ì§„ ì¹¸ë„ í•¨ê»˜ ì§€ì›Œì§‘ë‹ˆë‹¤.`);
      if(!ok) return;

      const p = activeProfile();
      let totalCells = 0;
      let clearedSelection = false;

      for(const s of hidden){
        const subj = normalizeSubject(s);
        const res = _deleteSubjectFromProfile(p, subj);
        totalCells += (res.removedRegular + res.removedNaesin);
        if(normalizeSubject(state.ui.subject) === subj){
          clearedSelection = true;
        }
      }

      if(clearedSelection){
        state.ui.subject = "";
        subjectInput.value = "";
      }

      state.ui.anchor = null;
      updateProfileStamp();
      saveState();
      renderAll();
      showToast(totalCells > 0 ? `ë¯¸ì™„ì„± ê³¼ëª© ì •ë¦¬ ì™„ë£Œ (${totalCells}ì¹¸)` : "ë¯¸ì™„ì„± ê³¼ëª© ì •ë¦¬ ì™„ë£Œ");
    }

    function buildSubjectChips(){
      const subjects = collectKnownSubjects();
      const hidden = collectHiddenSubjects();

      subjectChips.innerHTML = "";
      if(subjects.length === 0 && hidden.length === 0){
        return;
      }

      for(const subj of subjects){
        const wrap = document.createElement("div");
        wrap.className = "chipwrap";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chip";
        btn.dataset.subject = subj;
        btn.innerHTML = `<span class="dot" style="--c:${escapeHtml(getSubjectColor(subj) || autoPickColor(subj))}"></span>${escapeHtml(subj)}`;
        btn.addEventListener("click", () => {
          if(state.settings.locked) return;
          state.ui.subject = subj;
          // auto color
          if(state.settings.autoColor){
            state.ui.color = getSubjectColor(subj) || autoPickColor(subj);
            colorPicker.value = state.ui.color;
          }
          state.ui.anchor = null;
          saveState();
          renderAll();
        });
        if(normalizeSubject(state.ui.subject) === subj){
          btn.classList.add("on");
        }

        const del = document.createElement("button");
        del.type = "button";
        del.className = "chipdel danger";
        del.textContent = "Ã—";
        del.title = "ê³¼ëª© ì‚­ì œ";
        del.setAttribute("aria-label", `ê³¼ëª© ì‚­ì œ: ${subj}`);
        del.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if(state.settings.locked) return;
          const ok = confirm(`"${subj}" ê³¼ëª©ì„ ì‚­ì œí• ê¹Œìš”?

â€» ì´ ê³¼ëª©ìœ¼ë¡œ ì¹ í•´ì§„ ì¹¸ë„ í•¨ê»˜ ì§€ì›Œì§‘ë‹ˆë‹¤.`);
          if(!ok) return;
          const res = deleteSubjectEverywhere(subj, {render:true});
          const total = res.removedRegular + res.removedNaesin;
          showToast(total > 0 ? `"${subj}" ì‚­ì œ (${total}ì¹¸)` : `"${subj}" ì‚­ì œ`);
        });

        wrap.appendChild(btn);
        wrap.appendChild(del);
        subjectChips.appendChild(wrap);
      }

      // ìˆ¨ê²¨ì§„(ë¯¸ì™„ì„±/ì˜¤íƒ€) ê³¼ëª©ì´ ìˆìœ¼ë©´ ì •ë¦¬ ë²„íŠ¼ë§Œ ë…¸ì¶œ
      if(hidden.length > 0){
        const cleanBtn = document.createElement("button");
        cleanBtn.type = "button";
        cleanBtn.className = "chip";
        cleanBtn.textContent = `ğŸ§¹ ë¯¸ì™„ì„± ${hidden.length}ê°œ ì •ë¦¬`;
        cleanBtn.addEventListener("click", () => {
          if(state.settings.locked) return;
          cleanupHiddenSubjects();
        });
        subjectChips.appendChild(cleanBtn);
      }
    }

    // ====== Grid build + render ======
    function buildGridSkeleton(){
      cellMap.clear();
      gridEl.innerHTML = "";
      const slotMin = state.settings.slotMinutes;
      const slots = slotCount(slotMin);

      // Set grid rows: header row separate height
      // We'll implement header as separate elements with sticky top.
      // With grid-auto-rows same, we emulate header height by giving .th height var(--header-h) and align self.
      // Build header row
      const timeHead = document.createElement("div");
      timeHead.className = "th timehead";
      timeHead.textContent = "ì‹œê°„";
      gridEl.appendChild(timeHead);

      for(let d=0; d<7; d++){
        const th = document.createElement("div");
        th.className = "th";
        th.textContent = dayNames[d];
        gridEl.appendChild(th);
      }

      // Rows
      for(let s=0; s<slots; s++){
        const t = document.createElement("div");
        t.className = "time";
        t.textContent = minToTime(slotStartMin(s, slotMin));
        gridEl.appendChild(t);

        for(let d=0; d<7; d++){
          const wrapper = document.createElement("div");
          wrapper.className = "cell";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "cellbtn";
          btn.dataset.day = String(d);
          btn.dataset.slot = String(s);
          btn.addEventListener("click", onCellClick);
          // prevent persistent focus that can cause 'ì´ë™' ëŠë‚Œ
          btn.addEventListener("mouseup", () => btn.blur());
          btn.addEventListener("touchend", () => btn.blur());
          wrapper.appendChild(btn);
          gridEl.appendChild(wrapper);

          cellMap.set(slotKey(d,s), btn);
        }
      }
    }

    function computeRunStart(plan, d, s, map){
      const slotMin = state.settings.slotMinutes;
      const k = slotKey(d,s);
      const cur = map[k];
      if(!cur) return false;
      if(s === 0) return true;
      const prev = map[slotKey(d, s-1)];
      if(!prev) return true;
      return !(prev.subject === cur.subject && prev.color === cur.color);
    }

    function updateCell(d, s){
      const k = slotKey(d,s);
      const btn = cellMap.get(k);
      if(!btn) return;

      const p = activeProfile();
      const reg = p.regular[k] || null;
      const nae = p.naesin[k] || null;

      const conflict = !!(reg && nae);
      const vm = state.settings.viewMode;

      // background
      let bg = "";
      if(vm === "compare"){
        if(reg && nae){
          bg = `linear-gradient(135deg, ${reg.color} 0%, ${reg.color} 49%, ${nae.color} 51%, ${nae.color} 100%)`;
        }else if(reg){
          bg = reg.color;
        }else if(nae){
          bg = nae.color;
        }
      }else if(vm === "regular"){
        if(reg) bg = reg.color;
      }else if(vm === "naesin"){
        if(nae) bg = nae.color;
      }

      btn.style.background = bg ? bg : "transparent";
      btn.classList.toggle("filled", !!bg);
      btn.classList.toggle("conflict", conflict);

      // anchor highlight
      const a = state.ui.anchor;
      btn.classList.toggle("anchor", !!(a && a.day === d && a.slot === s));

      // labels
      let labelsHtml = "";
      if(vm === "compare"){
        if(reg && computeRunStart("regular", d, s, p.regular)){
          labelsHtml += `<span class="badge"><small>ì •</small> ${escapeHtml(reg.subject)}</span>`;
        }
        if(nae && computeRunStart("naesin", d, s, p.naesin)){
          labelsHtml += `<span class="badge"><small>ë‚´</small> ${escapeHtml(nae.subject)}</span>`;
        }
      }else if(vm === "regular"){
        if(reg && computeRunStart("regular", d, s, p.regular)){
          labelsHtml = `<span class="badge">${escapeHtml(reg.subject)}</span>`;
        }
        // if conflict exists, show tiny warning badge on run start maybe
        if(conflict && (!labelsHtml)){
          // if label hidden due to run continuation, still show subtle dot? ignore
        }
      }else if(vm === "naesin"){
        if(nae && computeRunStart("naesin", d, s, p.naesin)){
          labelsHtml = `<span class="badge">${escapeHtml(nae.subject)}</span>`;
        }
      }

      if(labelsHtml){
        btn.innerHTML = `<div class="labels">${labelsHtml}</div>`;
      }else{
        btn.innerHTML = "";
      }

      // title tooltip
      const slotMin = state.settings.slotMinutes;
      const start = minToTime(slotStartMin(s, slotMin));
      const end = minToTime(slotStartMin(s+1, slotMin));
      const day = dayNames[d];
      let tip = `${day} ${start}~${end}`;
      if(reg) tip += ` Â· ì •:${reg.subject}`;
      if(nae) tip += ` Â· ë‚´:${nae.subject}`;
      if(conflict) tip += " Â· âš ï¸ê²¹ì¹¨";
      btn.title = tip;
      btn.setAttribute("aria-label", tip);
    }

    function renderGrid(){
      // ensure skeleton built
      if(cellMap.size === 0){
        buildGridSkeleton();
      }
      const slotMin = state.settings.slotMinutes;
      const slots = slotCount(slotMin);
      for(let s=0; s<slots; s++){
        for(let d=0; d<7; d++){
          updateCell(d,s);
        }
      }
    }

    // ====== Editing ======
    function ensureSubjectReady(){
      if(subjectComposing){
        showToast("ê³¼ëª©ëª…ì„ ì…ë ¥ ì¤‘ì…ë‹ˆë‹¤. ì…ë ¥ì„ ì™„ë£Œí•œ ë’¤ ì„ íƒí•˜ì„¸ìš”.");
        return null;
      }
      const subj = normalizeSubject(state.ui.subject);
      if(!isValidSubjectName(subj)){
        showToast("ê³¼ëª©ëª…ì„ ì™„ì„±í•´ì„œ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: êµ­ì–´)");
        return null;
      }
      // apply auto color mapping
      if(state.settings.autoColor){
        const saved = getSubjectColor(subj);
        const picked = saved || autoPickColor(subj);
        state.ui.color = picked;
        colorPicker.value = picked;
        if(!saved){
          setSubjectColor(subj, picked);
        }
      }
      return subj;
    }

    function setSlot(plan, d, s, subject, color){
      const k = slotKey(d,s);
      const map = planMap(plan);
      map[k] = { subject, color };
    }

    function clearSlot(plan, d, s){
      const k = slotKey(d,s);
      const map = planMap(plan);
      if(map[k]) delete map[k];
    }

    function applyPaintRange(plan, d, s1, s2, subject, color){
      const a = Math.min(s1,s2);
      const b = Math.max(s1,s2);
      const other = otherPlan(plan);
      const otherMap = planMap(other);
      const thisMap = planMap(plan);

      let blocked = 0;
      let painted = 0;

      for(let s=a; s<=b; s++){
        const k = slotKey(d,s);
        if(state.settings.preventOverlap && otherMap[k]){
          blocked++;
          continue;
        }
        thisMap[k] = { subject, color };
        painted++;
      }
      return {painted, blocked};
    }

    function applyEraseRange(plan, d, s1, s2){
      const a = Math.min(s1,s2);
      const b = Math.max(s1,s2);
      const map = planMap(plan);
      let erased = 0;
      for(let s=a; s<=b; s++){
        const k = slotKey(d,s);
        if(map[k]){
          delete map[k];
          erased++;
        }
      }
      return erased;
    }

    function onCellClick(ev){
      if(state.settings.locked){
        // ë³´ê¸° ì „ìš©: í´ë¦­í•´ë„ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (ì´ë™/í‚¤ë³´ë“œ ë“± ë°©ì§€)
        state.ui.anchor = null;
        renderAll();
        return;
      }
      const btn = ev.currentTarget;
      const d = parseInt(btn.dataset.day, 10);
      const s = parseInt(btn.dataset.slot, 10);
      const plan = state.settings.activePlan;
      const tool = state.settings.tool;

      if(tool === "erase"){
        // ì§€ìš°ê¸°ë„: ê°™ì€ ìš”ì¼ì—ì„œ ì‹œì‘ì¹¸ â†’ ëì¹¸ìœ¼ë¡œ ë²”ìœ„ ì‚­ì œ
        if(state.ui.anchor && state.ui.anchor.day === d){
          const erased = applyEraseRange(plan, d, state.ui.anchor.slot, s);
          state.ui.anchor = null;
          updateProfileStamp();
          saveState();
          showToast(erased > 0 ? `ì‚­ì œ ${erased}ì¹¸` : "ì‚­ì œí•  ì¹¸ì´ ì—†ìŠµë‹ˆë‹¤");
          renderAll();
          return;
        }

        // anchor ì„¤ì • + í˜„ì¬ ì¹¸ ì§€ìš°ê¸°
        state.ui.anchor = { day: d, slot: s };
        clearSlot(plan, d, s);
        updateProfileStamp();
        saveState();
        renderAll();
        return;
      }

      // paint
      const subject = ensureSubjectReady();
      if(!subject) return;

      const color = state.ui.color;

      // first click sets anchor; second click fills range (same day)
      if(state.ui.anchor && state.ui.anchor.day === d){
        const res = applyPaintRange(plan, d, state.ui.anchor.slot, s, subject, color);
        state.ui.anchor = null;
        updateProfileStamp();
        saveState();
        if(res.blocked > 0 && res.painted === 0){
          showToast(`ê²¹ì¹¨ìœ¼ë¡œ ì°¨ë‹¨ë¨ (${res.blocked}ì¹¸)`);
        }else if(res.blocked > 0){
          showToast(`ì±„ì›€ ${res.painted}ì¹¸ Â· ê²¹ì¹¨ ì°¨ë‹¨ ${res.blocked}ì¹¸`);
        }else{
          showToast(`ì±„ì›€ ${res.painted}ì¹¸`);
        }
        renderAll();
        return;
      }

      // set anchor and paint one cell immediately
      state.ui.anchor = { day: d, slot: s };
      // paint this cell (respect overlap rule)
      const other = otherPlan(plan);
      const otherMap = planMap(other);
      if(state.settings.preventOverlap && otherMap[slotKey(d,s)]){
        showToast("ê²¹ì¹˜ëŠ” ì‹œê°„ì´ë¼ ì±„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        // anchor stays? better clear to avoid confusion
        state.ui.anchor = null;
        renderAll();
        return;
      }
      setSlot(plan, d, s, subject, color);
      updateProfileStamp();
      saveState();
      renderAll();
    }

    // ====== Lists / Conflicts ======
    function buildEntriesForPlan(map){
      const slotMin = state.settings.slotMinutes;
      const slots = slotCount(slotMin);
      const entries = [];
      for(let d=0; d<7; d++){
        let s=0;
        while(s<slots){
          const item = map[slotKey(d,s)];
          if(!item){ s++; continue; }
          const start = s;
          let end = s+1;
          while(end<slots){
            const nxt = map[slotKey(d,end)];
            if(!nxt || nxt.subject !== item.subject || nxt.color !== item.color) break;
            end++;
          }
          entries.push({
            day: d, startSlot: start, endSlot: end,
            subject: item.subject, color: item.color
          });
          s = end;
        }
      }
      return entries;
    }

    function renderEntries(container, plan){
      const map = planMap(plan);
      const entries = buildEntriesForPlan(map);
      container.innerHTML = "";
      if(entries.length === 0){
        container.innerHTML = `<div class="hint" style="padding:0;">(ë¹„ì–´ìˆìŒ)</div>`;
        return;
      }
      const slotMin = state.settings.slotMinutes;
      for(const e of entries){
        const startMin = slotStartMin(e.startSlot, slotMin);
        const endMin = slotStartMin(e.endSlot, slotMin);
        const time = `${dayNames[e.day]} Â· ${minToTime(startMin)}~${minToTime(endMin)}`;
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <div class="left">
            <div class="topline"><span class="dot" style="--c:${escapeHtml(e.color)}"></span>${escapeHtml(e.subject)}</div>
            <div class="meta">${escapeHtml(time)}</div>
          </div>
          <div class="actions">
            <button type="button" class="danger">ì‚­ì œ</button>
          </div>
        `;
        const delBtn = div.querySelector("button");
        delBtn.disabled = !!state.settings.locked;
        delBtn.addEventListener("click", () => {
          if(state.settings.locked) return;
          const map = planMap(plan);
          for(let s=e.startSlot; s<e.endSlot; s++){
            delete map[slotKey(e.day,s)];
          }
          state.ui.anchor = null;
          updateProfileStamp();
          saveState();
          renderAll();
        });
        container.appendChild(div);
      }
    }

    function buildConflictEntries(){
      const p = activeProfile();
      const slotMin = state.settings.slotMinutes;
      const slots = slotCount(slotMin);
      const entries = [];
      for(let d=0; d<7; d++){
        let s=0;
        while(s<slots){
          const r = p.regular[slotKey(d,s)];
          const n = p.naesin[slotKey(d,s)];
          if(!(r && n)){ s++; continue; }
          const start = s;
          let end = s+1;
          while(end<slots){
            const rr = p.regular[slotKey(d,end)];
            const nn = p.naesin[slotKey(d,end)];
            if(!(rr && nn)) break;
            if(rr.subject !== r.subject || nn.subject !== n.subject || rr.color !== r.color || nn.color !== n.color) break;
            end++;
          }
          entries.push({
            day: d, startSlot: start, endSlot: end,
            regular: r, naesin: n
          });
          s = end;
        }
      }
      return entries;
    }

    function renderConflicts(){
      const entries = buildConflictEntries();
      listConflicts.innerHTML = "";
      if(entries.length === 0){
        listConflicts.innerHTML = `<div class="hint" style="padding:0;">(ê²¹ì¹¨ ì—†ìŒ ğŸ‰)</div>`;
        return;
      }
      const slotMin = state.settings.slotMinutes;
      for(const e of entries){
        const startMin = slotStartMin(e.startSlot, slotMin);
        const endMin = slotStartMin(e.endSlot, slotMin);
        const time = `${dayNames[e.day]} Â· ${minToTime(startMin)}~${minToTime(endMin)}`;
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <div class="left">
            <div class="topline">
              <span class="dot" style="--c:${escapeHtml(e.regular.color)}"></span>ì •:${escapeHtml(e.regular.subject)}
              <span class="dot" style="--c:${escapeHtml(e.naesin.color)}; margin-left:8px;"></span>ë‚´:${escapeHtml(e.naesin.subject)}
            </div>
            <div class="meta">âš ï¸ ${escapeHtml(time)}</div>
          </div>
          <div class="actions">
            <button type="button" class="danger">ì •ê·œ ì§€ìš°ê¸°</button>
            <button type="button" class="danger">ë‚´ì‹  ì§€ìš°ê¸°</button>
          </div>
        `;
        const [btnReg, btnNae] = div.querySelectorAll("button");
        btnReg.disabled = !!state.settings.locked;
        btnNae.disabled = !!state.settings.locked;

        btnReg.addEventListener("click", () => {
          if(state.settings.locked) return;
          const map = planMap("regular");
          for(let s=e.startSlot; s<e.endSlot; s++){
            delete map[slotKey(e.day,s)];
          }
          state.ui.anchor = null;
          updateProfileStamp();
          saveState();
          renderAll();
        });
        btnNae.addEventListener("click", () => {
          if(state.settings.locked) return;
          const map = planMap("naesin");
          for(let s=e.startSlot; s<e.endSlot; s++){
            delete map[slotKey(e.day,s)];
          }
          state.ui.anchor = null;
          updateProfileStamp();
          saveState();
          renderAll();
        });

        listConflicts.appendChild(div);
      }
    }

    function renderLists(){
      renderEntries(listRegular, "regular");
      renderEntries(listNaesin, "naesin");
      renderConflicts();
    }

    // ====== Payments UI ======
    function populatePayDayOptions(){
      if(!payDay || payDay.dataset.built) return;
      for(let i=1;i<=31;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${i}ì¼`;
        payDay.appendChild(opt);
      }
      payDay.dataset.built = "1";
    }

    function refreshAcademySelect(){
      if(!mkAcademy) return;
      const cur = mkAcademy.value;
      mkAcademy.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "í•™ì›(ì„ íƒ)";
      mkAcademy.appendChild(opt0);

      const list = academies().slice().sort((a,b) => (a.name||"").localeCompare(b.name||"", "ko"));
      for(const a of list){
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.subject ? `${a.name} Â· ${a.subject}` : a.name;
        mkAcademy.appendChild(opt);
      }

      if(cur && Array.from(mkAcademy.options).some(o => o.value === cur)){
        mkAcademy.value = cur;
      }else{
        mkAcademy.value = "";
      }
    }

    function updatePayMethodUI(){
      if(!payMethod || !payBank || !payAccount) return;
      const m = String(payMethod.value || "").trim();
      const showAccount = (m === "transfer" || m === "auto");
      // ê³„ì¢Œì´ì²´/ìë™ì´ì²´ë§Œ ê³„ì¢Œ ì…ë ¥ì¹¸ ë…¸ì¶œ
      payBank.classList.toggle("hidden", !showAccount);
      payAccount.classList.toggle("hidden", !showAccount);
    }

    function renderPaymentEntry(container, a, due, ym){
      const paid = isPaid(a.id, ym);
      const diff = daysDiff(new Date(), due);
      const dueText = `${toYMD(due)} Â· ${ddayLabel(diff)}`;
      const feeText = a.fee ? `${fmtMoney(a.fee)}ì›` : "-";
      const remindDays = Array.isArray(a.remindDays) ? a.remindDays : [];
      const remindText = remindDays.length
        ? `${remindDays.map(d => d===0 ? "ë‹¹ì¼" : `${d}ì¼ì „`).join(" Â· ")} Â· ${a.remindTime || "09:00"}`
        : "ì—†ìŒ";

      const methodText = payMethodLabel(a.payMethod);
      const acctText = formatBankAccount(a.bank, a.account);

      const statusPill = paid
        ? `<span class="pill ok">ì™„ë£Œ</span>`
        : (diff < 0 ? `<span class="pill due">ë¯¸ê²°ì œ(ì—°ì²´)</span>` : `<span class="pill wait">ë¯¸ê²°ì œ</span>`);

      const subjPill = a.subject ? `<span class="pill">${escapeHtml(a.subject)}</span>` : "";
      const methodPill = methodText ? `<span class="pill">${escapeHtml(methodText)}</span>` : "";

      let methodLine = "";
      if(methodText && acctText){
        methodLine = `<div class="meta">ë°©ë²•: <b>${escapeHtml(methodText)}</b> Â· ê³„ì¢Œ: <b>${escapeHtml(acctText)}</b></div>`;
      }else if(methodText){
        methodLine = `<div class="meta">ë°©ë²•: <b>${escapeHtml(methodText)}</b></div>`;
      }else if(acctText){
        methodLine = `<div class="meta">ê³„ì¢Œ: <b>${escapeHtml(acctText)}</b></div>`;
      }

      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <div class="left">
          <div class="topline">${escapeHtml(a.name)} ${statusPill} ${subjPill} ${methodPill}</div>
          <div class="meta">ê²°ì œì¼: <b>${escapeHtml(dueText)}</b> Â· ê¸ˆì•¡: <b>${escapeHtml(feeText)}</b></div>
          ${methodLine}
          <div class="meta">ì•Œë¦¼: ${escapeHtml(remindText)}</div>
        </div>
        <div class="actions">
          <button type="button" class="btn-pay">${paid ? "ë˜ëŒë¦¬ê¸°" : "ê²°ì œì™„ë£Œ"}</button>
          <button type="button" class="btn-edit">ì •ë³´ìˆ˜ì •</button>
          ${acctText ? '<button type="button" class="btn-copy">ê³„ì¢Œë³µì‚¬</button>' : ""}
          <button type="button" class="danger btn-del">ì‚­ì œ</button>
        </div>
      `;
      const btnPay = div.querySelector(".btn-pay");
      const btnEdit = div.querySelector(".btn-edit");
      const btnCopy = div.querySelector(".btn-copy");
      const btnDel = div.querySelector(".btn-del");

      const locked = !!state.settings.locked;
      if(btnPay) btnPay.disabled = locked;
      if(btnEdit) btnEdit.disabled = locked;
      if(btnCopy) btnCopy.disabled = locked;
      if(btnDel) btnDel.disabled = locked;

      btnPay.addEventListener("click", () => {
        if(state.settings.locked) return;
        if(paid){
          const ok = confirm(`${a.name} (${ym}) ê²°ì œì™„ë£Œ í‘œì‹œë¥¼ ë˜ëŒë¦´ê¹Œìš”?`);
          if(!ok) return;
          unmarkPaid(a.id, ym);
          showToast("ë˜ëŒë ¸ìŠµë‹ˆë‹¤");
          renderAll();
          return;
        }
        const def = a.fee ? String(a.fee) : "";
        const raw = prompt(`${a.name} ê²°ì œ ê¸ˆì•¡(ì›)ì„ ì…ë ¥í•˜ì„¸ìš”`, def);
        if(raw === null) return;
        const n = parseInt(String(raw).replace(/[,\s]/g,""), 10);
        const amt = Number.isFinite(n) ? n : (a.fee || 0);
        markPaid(a.id, ym, amt);
        showToast("ê²°ì œ ì™„ë£Œ ì²˜ë¦¬");
        renderAll();
      });

      btnEdit.addEventListener("click", () => {
        if(state.settings.locked) return;
        const curLabel = payMethodLabel(a.payMethod) || "";
        const mRaw = prompt("ê²°ì œë°©ë²• (ê³„ì¢Œì´ì²´/ìë™ì´ì²´/ì¹´ë“œ/ê°„í¸ê²°ì œ/í˜„ê¸ˆ/ê¸°íƒ€)", curLabel);
        if(mRaw === null) return;
        const bRaw = prompt("ì€í–‰ (ì—†ìœ¼ë©´ ë¹„ìš°ê¸°)", a.bank || "");
        if(bRaw === null) return;
        const accRaw = prompt("ê³„ì¢Œë²ˆí˜¸ (ì—†ìœ¼ë©´ ë¹„ìš°ê¸°)", a.account || "");
        if(accRaw === null) return;

        a.payMethod = parsePayMethodInput(mRaw, a.payMethod || "");
        a.bank = String(bRaw||"").trim();
        a.account = String(accRaw||"").trim().replace(/\s+/g, "");
        a.updatedAt = nowStamp();
        updateProfileStamp();
        saveState();
        showToast("ê²°ì œ ì •ë³´ ìˆ˜ì •");
        renderAll();
      });

      if(btnCopy){
        btnCopy.addEventListener("click", async () => {
          if(state.settings.locked) return;
          const text = formatBankAccount(a.bank, a.account);
          if(!text){
            showToast("ë³µì‚¬í•  ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤");
            return;
          }
          try{
            if(navigator.clipboard && navigator.clipboard.writeText){
              await navigator.clipboard.writeText(text);
              showToast("ê³„ì¢Œë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤");
            }else{
              // fallback: ì‚¬ìš©ìê°€ ì§ì ‘ ë³µì‚¬
              prompt("ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”", text);
            }
          }catch(e){
            prompt("ë³µì‚¬í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”", text);
          }
        });
      }

      btnDel.addEventListener("click", () => {
        if(state.settings.locked) return;
        const ok = confirm(`"${a.name}" í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?\n(ê²°ì œ ê¸°ë¡ë„ í•¨ê»˜ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤)`);
        if(!ok) return;
        const arr = academies();
        const idx = arr.findIndex(x => x.id === a.id);
        if(idx >= 0) arr.splice(idx, 1);
        updateProfileStamp();
        saveState();
        showToast("ì‚­ì œ ì™„ë£Œ");
        renderAll();
      });

      container.appendChild(div);
    }

    function renderPayments(){
      populatePayDayOptions();
      updateNotifHint();
      refreshAcademySelect();
      updatePayMethodUI();

      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();

      const list = academies().slice().filter(a => a && a.name).sort((a,b) => (a.name||"").localeCompare(b.name||"", "ko"));

      // this month
      payListThis.innerHTML = "";
      const thisItems = [];
      for(const a of list){
        if(!a.payDay) continue;
        const due = dueDateForMonth(a.payDay, y, m, a.remindTime || "09:00");
        const ym = ymKey(due);
        thisItems.push({a, due, ym});
      }
      thisItems.sort((x,y) => x.due - y.due);
      if(thisItems.length === 0){
        payListThis.innerHTML = `<div class="hint" style="padding:0;">(ë“±ë¡ëœ ê²°ì œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤)</div>`;
      }else{
        for(const it of thisItems){
          renderPaymentEntry(payListThis, it.a, it.due, it.ym);
        }
      }

      // next unpaid
      payListNext.innerHTML = "";
      const nextItems = [];
      for(const a of list){
        const nx = nextUnpaidDue(a, now);
        if(!nx) continue;
        nextItems.push({a, due: nx.due, ym: nx.ym});
      }
      nextItems.sort((x,y) => x.due - y.due);
      if(nextItems.length === 0){
        payListNext.innerHTML = `<div class="hint" style="padding:0;">(ë¯¸ê²°ì œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰)</div>`;
      }else{
        for(const it of nextItems){
          renderPaymentEntry(payListNext, it.a, it.due, it.ym);
        }
      }
    }

    // ====== Makeup UI ======
    function statusLabel(st){
      if(st === "requested") return "ìš”ì²­ë¨";
      if(st === "scheduled") return "í™•ì •";
      if(st === "done") return "ì™„ë£Œ";
      if(st === "canceled") return "ì·¨ì†Œ";
      return st || "-";
    }
    function statusPillClass(st){
      if(st === "done") return "ok";
      if(st === "requested") return "wait";
      if(st === "scheduled") return "";
      if(st === "canceled") return "due";
      return "";
    }

    function renderMakeupEntry(container, mk){
      const a = mk.academyId ? findAcademyById(mk.academyId) : null;
      const academyName = a ? a.name : "(í•™ì› ë¯¸ì§€ì •)";
      const subject = mk.subject || (a && a.subject) || "(ê³¼ëª© ë¯¸ì§€ì •)";
      const sd = makeupStartDate(mk);
      let when = "ë‚ ì§œ ë¯¸ì •";
      let dd = "";
      if(sd){
        when = `${mk.date} Â· ${mk.start || ""}${mk.end ? `~${mk.end}` : ""}`;
        dd = ddayLabel(daysDiff(new Date(), sd));
      }else if(mk.date){
        when = mk.date;
      }

      const pillCls = statusPillClass(mk.status);
      const pill = `<span class="pill ${pillCls}">${escapeHtml(statusLabel(mk.status))}</span>`;
      const ddPill = dd ? `<span class="pill ${daysDiff(new Date(), sd) < 0 ? "due" : ""}">${escapeHtml(dd)}</span>` : "";

      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <div class="left">
          <div class="topline">${escapeHtml(subject)} ${pill} ${ddPill}</div>
          <div class="meta">í•™ì›: <b>${escapeHtml(academyName)}</b></div>
          <div class="meta">ì¼ì •: <b>${escapeHtml(when)}</b> Â· ì•Œë¦¼: ${mk.remindMin && Number(mk.remindMin) > 0 ? `${mk.remindMin}ë¶„ ì „` : "ì—†ìŒ"}</div>
        </div>
        <div class="actions">
          <button type="button">ìˆ˜ì •</button>
          <button type="button">ìƒíƒœ</button>
          <button type="button" class="danger">ì‚­ì œ</button>
        </div>
      `;
      const [btnEdit, btnStatus, btnDel] = div.querySelectorAll("button");
      btnEdit.disabled = !!state.settings.locked;
      btnStatus.disabled = !!state.settings.locked;
      btnDel.disabled = !!state.settings.locked;

      btnEdit.addEventListener("click", () => {
        if(state.settings.locked) return;
        const newSubj = normalizeSubject(prompt("ê³¼ëª©", subject) || "");
        if(newSubj === "" && subject !== "(ê³¼ëª© ë¯¸ì§€ì •)"){
          // allow empty only if user explicitly clears; keep
        }
        const newDate = (prompt("ë‚ ì§œ (YYYY-MM-DD, ë¹„ìš°ë©´ ë¯¸ì •)", mk.date || "") || "").trim();
        if(newDate && !parseYMD(newDate)){
          showToast("ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
          return;
        }
        const newStart = (prompt("ì‹œì‘ ì‹œê°„ (HH:MM)", mk.start || "") || "").trim();
        const newEnd = (prompt("ì¢…ë£Œ ì‹œê°„ (HH:MM)", mk.end || "") || "").trim();
        const newRem = parseInt(prompt("ì•Œë¦¼(ë¶„ ì „, 0=ì—†ìŒ)", String(mk.remindMin ?? 60)) || "0", 10);
        mk.subject = newSubj || "";
        mk.date = newDate;
        mk.start = newStart;
        mk.end = newEnd;
        mk.remindMin = Number.isFinite(newRem) ? newRem : 0;
        mk.updatedAt = nowStamp();
        updateProfileStamp();
        saveState();
        showToast("ìˆ˜ì • ì™„ë£Œ");
        renderAll();
      });

      btnStatus.addEventListener("click", () => {
        if(state.settings.locked) return;
        const next = mk.status === "requested" ? "scheduled" : (mk.status === "scheduled" ? "done" : (mk.status === "done" ? "requested" : "requested"));
        mk.status = next;
        mk.updatedAt = nowStamp();
        updateProfileStamp();
        saveState();
        showToast(`ìƒíƒœ ë³€ê²½: ${statusLabel(next)}`);
        renderAll();
      });

      btnDel.addEventListener("click", () => {
        if(state.settings.locked) return;
        const ok = confirm("ì´ ë³´ê°•ì„ ì‚­ì œí• ê¹Œìš”?");
        if(!ok) return;
        const arr = makeups();
        const idx = arr.findIndex(x => x.id === mk.id);
        if(idx >= 0) arr.splice(idx, 1);
        updateProfileStamp();
        saveState();
        showToast("ì‚­ì œ ì™„ë£Œ");
        renderAll();
      });

      container.appendChild(div);
    }

    function renderMakeups(){
      refreshAcademySelect();
      updateNotifHint();

      const now = new Date();
      const today0 = startOfDay(now);
      const all = makeups().slice();

      const pending = [];
      const upcoming = [];
      const done = [];

      for(const mk of all){
        if(mk.status === "done" || mk.status === "canceled"){
          done.push(mk);
          continue;
        }
        if(mk.status === "requested" || !mk.date){
          pending.push(mk);
          continue;
        }
        if(mk.status === "scheduled"){
          const sd = makeupStartDate(mk);
          if(!sd){
            pending.push(mk);
          }else if(sd >= today0){
            upcoming.push(mk);
          }else{
            // ì§€ë‚œ ì¼ì •ì¸ë° ì™„ë£Œì²˜ë¦¬ ì•ˆë¨ -> ëŒ€ê¸°í•¨ìœ¼ë¡œ
            pending.push(mk);
          }
          continue;
        }
        pending.push(mk);
      }

      const sortByDate = (a,b) => {
        const da = makeupStartDate(a) || new Date(8640000000000000);
        const db = makeupStartDate(b) || new Date(8640000000000000);
        return da - db;
      };
      pending.sort(sortByDate);
      upcoming.sort(sortByDate);
      done.sort((a,b) => {
        const da = makeupStartDate(a) || parseYMD(a.date) || new Date(0);
        const db = makeupStartDate(b) || parseYMD(b.date) || new Date(0);
        return db - da;
      });

      mkListPending.innerHTML = "";
      mkListUpcoming.innerHTML = "";
      mkListDone.innerHTML = "";

      if(pending.length === 0){
        mkListPending.innerHTML = `<div class="hint" style="padding:0;">(ëŒ€ê¸° ì—†ìŒ)</div>`;
      }else{
        for(const mk of pending){
          renderMakeupEntry(mkListPending, mk);
        }
      }
      if(upcoming.length === 0){
        mkListUpcoming.innerHTML = `<div class="hint" style="padding:0;">(ì˜ˆì •ëœ ë³´ê°• ì—†ìŒ)</div>`;
      }else{
        for(const mk of upcoming){
          renderMakeupEntry(mkListUpcoming, mk);
        }
      }
      if(done.length === 0){
        mkListDone.innerHTML = `<div class="hint" style="padding:0;">(ì™„ë£Œ/ì·¨ì†Œ ì—†ìŒ)</div>`;
      }else{
        for(const mk of done){
          renderMakeupEntry(mkListDone, mk);
        }
      }
    }

    // ====== Local notifications (ì•±ì´ ì¼œì ¸ ìˆì„ ë•Œ) + ICS export ======
    async function showLocalNotification(title, body){
      if(!("Notification" in window)) return false;
      if(Notification.permission !== "granted") return false;
      const opts = {
        body,
        icon: "./icons/icon-192.png",
        badge: "./icons/icon-96.png",
      };
      try{
        if("serviceWorker" in navigator){
          const reg = await navigator.serviceWorker.ready;
          await reg.showNotification(title, opts);
        }else{
          new Notification(title, opts);
        }
        return true;
      }catch(e){
        console.warn("notification failed", e);
        return false;
      }
    }

    function fireOnce(key){
      state.meta = state.meta || { fired: {} };
      state.meta.fired = state.meta.fired || {};
      if(state.meta.fired[key]) return false;
      state.meta.fired[key] = nowStamp();
      saveState();
      return true;
    }

    async function checkDueReminders(){
      if(!("Notification" in window)) return;
      if(Notification.permission !== "granted") return;

      const now = new Date();
      const windowMs = 6 * 60 * 60 * 1000; // 6ì‹œê°„ ì´ë‚´ë©´ "ëŠ¦ê²Œë¼ë„" ì•Œë¦¼

      // payments
      for(const a of academies()){
        if(!a.payDay) continue;
        const nx = nextUnpaidDue(a, now);
        if(!nx) continue;
        const due = nx.due;
        const ym = nx.ym;
        const remindDays = Array.isArray(a.remindDays) ? a.remindDays : [];
        const base = due.getTime();
        for(const d of remindDays){
          const off = safeInt(d, null);
          if(off === null) continue;
          const at = new Date(base - off * 86400000);
          const diff = now.getTime() - at.getTime();
          if(diff < 0 || diff > windowMs) continue;
          const key = `pay|${state.activeProfileId}|${a.id}|${ym}|${off}`;
          if(!fireOnce(key)) continue;
          const feeText = a.fee ? `${fmtMoney(a.fee)}ì›` : "";
          await showLocalNotification(
            `ê²°ì œ ì•Œë¦¼: ${a.name}`,
            `${toYMD(due)} ê²°ì œì¼ Â· ${ddayLabel(daysDiff(now, due))}${feeText ? ` Â· ${feeText}` : ""}`
          );
        }
      }

      // makeups
      for(const mk of makeups()){
        if(mk.status !== "scheduled") continue;
        const sd = makeupStartDate(mk);
        if(!sd) continue;
        const rm = safeInt(mk.remindMin, 0) || 0;
        if(rm <= 0) continue;
        const at = new Date(sd.getTime() - rm * 60000);
        const diff = now.getTime() - at.getTime();
        if(diff < 0 || diff > windowMs) continue;
        const key = `mk|${state.activeProfileId}|${mk.id}|${rm}|${mk.date}|${mk.start}`;
        if(!fireOnce(key)) continue;
        const a = mk.academyId ? findAcademyById(mk.academyId) : null;
        const academyName = a ? a.name : "";
        await showLocalNotification(
          `ë³´ê°• ì•Œë¦¼: ${mk.subject || "ë³´ê°•"}`,
          `${mk.date} ${mk.start || ""}${academyName ? ` Â· ${academyName}` : ""}`
        );
      }
    }

    let reminderTimer = null;
    function startReminderTicker(){
      if(reminderTimer) return;
      reminderTimer = setInterval(checkDueReminders, 60 * 1000);
      setTimeout(checkDueReminders, 1500);
      document.addEventListener("visibilitychange", () => {
        if(!document.hidden) checkDueReminders();
      });
    }

    function icsEscape(s){
      return String(s||"")
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/\r/g, "")
        .replace(/;/g, "\\;")
        .replace(/,/g, "\\,");
    }
    function icsDT(d){
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}T${pad2(d.getHours())}${pad2(d.getMinutes())}00`;
    }
    function downloadText(filename, text, mime="text/plain;charset=utf-8"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    function exportICS(){
      const p = activeProfile();
      const now = new Date();
      const lines = [];
      lines.push("BEGIN:VCALENDAR");
      lines.push("VERSION:2.0");
      lines.push("PRODID:-//JW Schedule//KO");
      lines.push("CALSCALE:GREGORIAN");
      lines.push("METHOD:PUBLISH");
      lines.push(`X-WR-CALNAME:${icsEscape("ì •ìš° í•™ì› ì•Œë¦¼")}`);

      // payments: next 6 months
      for(const a of academies()){
        if(!a.payDay) continue;
        const remindDays = Array.isArray(a.remindDays) ? a.remindDays : [];
        for(let i=0;i<6;i++){
          const base = new Date(now.getFullYear(), now.getMonth()+i, 1);
          const due = dueDateForMonth(a.payDay, base.getFullYear(), base.getMonth(), a.remindTime || "09:00");
          const ym = ymKey(due);
          if(isPaid(a.id, ym)) continue; // ì´ë¯¸ ì²˜ë¦¬í•œ ë‹¬ì€ ì œì™¸
          // ì§€ë‚œ ë‚ ì§œëŠ” ì œì™¸
          if(due.getTime() < startOfDay(now).getTime()) continue;
          const end = new Date(due.getTime() + 10*60000);
          lines.push("BEGIN:VEVENT");
          lines.push(`UID:${icsEscape(`pay-${a.id}-${ym}`)}`);
          lines.push(`DTSTAMP:${icsDT(now)}`);
          lines.push(`SUMMARY:${icsEscape(`ê²°ì œ: ${a.name}`)}`);
          const mLabel = payMethodLabel(a.payMethod);
          const acct = formatBankAccount(a.bank, a.account);
          const desc = [
            `í•™ê¸°: ${p.name}`,
            a.subject ? `ê³¼ëª©: ${a.subject}` : null,
            `ê²°ì œì¼: ${toYMD(due)}`,
            `ê¸ˆì•¡: ${a.fee ? fmtMoney(a.fee)+"ì›" : "-"}`,
            mLabel ? `ê²°ì œë°©ë²•: ${mLabel}` : null,
            acct ? `ê³„ì¢Œ: ${acct}` : null,
          ].filter(Boolean).join("\n");
          lines.push(`DESCRIPTION:${icsEscape(desc)}`);
          lines.push(`DTSTART:${icsDT(due)}`);
          lines.push(`DTEND:${icsDT(end)}`);
          for(const d of remindDays){
            const off = safeInt(d, null);
            if(off === null) continue;
            lines.push("BEGIN:VALARM");
            if(off === 0){
              lines.push("TRIGGER:-PT0M");
            }else{
              lines.push(`TRIGGER:-P${off}D`);
            }
            lines.push("ACTION:DISPLAY");
            lines.push(`DESCRIPTION:${icsEscape(`ê²°ì œ ì•Œë¦¼: ${a.name}`)}`);
            lines.push("END:VALARM");
          }
          lines.push("END:VEVENT");
        }
      }

      // makeups: scheduled only
      for(const mk of makeups()){
        if(mk.status !== "scheduled") continue;
        const sd = makeupStartDate(mk);
        if(!sd) continue;
        if(sd.getTime() < startOfDay(now).getTime()) continue;
        const a = mk.academyId ? findAcademyById(mk.academyId) : null;
        const academyName = a ? a.name : "";
        const endT = parseTimeHHMM(mk.end || "", mk.start || "00:00");
        const end = new Date(sd.getFullYear(), sd.getMonth(), sd.getDate(), endT.hh, endT.mm, 0, 0);
        const finalEnd = end.getTime() > sd.getTime() ? end : new Date(sd.getTime() + 60*60000);
        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${icsEscape(`mk-${mk.id}`)}`);
        lines.push(`DTSTAMP:${icsDT(now)}`);
        lines.push(`SUMMARY:${icsEscape(`ë³´ê°•: ${mk.subject || ""}${academyName ? ` (${academyName})` : ""}`)}`);
        const desc = `í•™ê¸°: ${p.name}\ní•™ì›: ${academyName || "-"}\nì¼ì •: ${mk.date} ${mk.start || ""}${mk.end ? `~${mk.end}` : ""}`;
        lines.push(`DESCRIPTION:${icsEscape(desc)}`);
        lines.push(`DTSTART:${icsDT(sd)}`);
        lines.push(`DTEND:${icsDT(finalEnd)}`);
        const rm = safeInt(mk.remindMin, 0) || 0;
        if(rm > 0){
          lines.push("BEGIN:VALARM");
          if(rm % 1440 === 0){
            lines.push(`TRIGGER:-P${rm/1440}D`);
          }else if(rm % 60 === 0){
            lines.push(`TRIGGER:-PT${rm/60}H`);
          }else{
            lines.push(`TRIGGER:-PT${rm}M`);
          }
          lines.push("ACTION:DISPLAY");
          lines.push(`DESCRIPTION:${icsEscape(`ë³´ê°• ì•Œë¦¼: ${mk.subject || "ë³´ê°•"}`)}`);
          lines.push("END:VALARM");
        }
        lines.push("END:VEVENT");
      }

      lines.push("END:VCALENDAR");

      const filename = `ì •ìš°ìŠ¤ì¼€ì¤„_ì•Œë¦¼_${toYMD(now)}.ics`;
      downloadText(filename, lines.join("\r\n"), "text/calendar;charset=utf-8");
      showToast("ìº˜ë¦°ë” íŒŒì¼(.ics)ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤");
    }

    // ====== Events ======
    tabSeg.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-tab]");
      if(!b) return;
      const nextTab = b.dataset.tab;
      state.settings.tab = nextTab;
      state.ui.anchor = null;
      saveState();

      // í¸ì˜: ì‹œê°„í‘œì—ì„œ ì„ íƒí•œ ê³¼ëª©ì„ ê²°ì œ/ë³´ê°• ì…ë ¥ì¹¸ì— ìë™ ë³µì‚¬
      const subj = normalizeSubject(state.ui.subject);
      if(isValidSubjectName(subj)){
        if(nextTab === "payments" && paySubject && !paySubject.value) paySubject.value = subj;
        if(nextTab === "makeup" && mkSubject && !mkSubject.value) mkSubject.value = subj;
      }
      renderAll();
    });

    if(mkAcademy){
      mkAcademy.addEventListener("change", () => {
        if(state.settings.locked) return;
        const a = mkAcademy.value ? findAcademyById(mkAcademy.value) : null;
        if(a && mkSubject && !mkSubject.value){
          mkSubject.value = a.subject || "";
        }
      });
    }

    if(payMethod){
      payMethod.addEventListener("change", () => {
        if(state.settings.locked) return;
        updatePayMethodUI();
      });
    }

    notifPermBtn.addEventListener("click", async () => {
      if(!("Notification" in window)){
        showToast("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        updateNotifHint();
        return;
      }
      try{
        const p = await Notification.requestPermission();
        updateNotifHint();
        if(p === "granted"){
          showToast("ì•Œë¦¼ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤");
          startReminderTicker();
          checkDueReminders();
        }else if(p === "denied"){
          showToast("ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤");
        }else{
          showToast("ì•Œë¦¼ì´ ì•„ì§ ë¯¸ì„¤ì •ì…ë‹ˆë‹¤");
        }
      }catch(err){
        console.warn("requestPermission failed", err);
        showToast("ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨");
      }
    });

    icsExportBtn.addEventListener("click", () => {
      exportICS();
    });

    payAddBtn.addEventListener("click", () => {
      if(state.settings.locked) return;
      const name = normalizeSubject(payName.value);
      if(!name){
        showToast("í•™ì›/ìˆ˜ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”");
        return;
      }
      const day = safeInt(payDay.value, null);
      if(!day){
        showToast("ê²°ì œì¼(ì¼)ì„ ì„ íƒí•˜ì„¸ìš”");
        return;
      }
      const subject = normalizeSubject(paySubject.value);
      const fee = safeInt(payFee.value, null);
      const method = (payMethod && payMethod.value) ? String(payMethod.value).trim() : "";
      const bank = (payBank && payBank.value) ? String(payBank.value).trim() : "";
      const account = (payAccount && payAccount.value) ? String(payAccount.value).trim().replace(/\s+/g, "") : "";
      const remindDays = (payRemind.value || "")
        .split(",")
        .map(s => safeInt(s, null))
        .filter(x => x !== null);
      const remindTime = (payTime.value || "09:00").trim();

      academies().push({
        id: uid(),
        name,
        subject,
        fee,
        payDay: day,
        payMethod: method,
        bank,
        account,
        remindDays,
        remindTime,
        createdAt: nowStamp(),
        updatedAt: nowStamp()
      });
      updateProfileStamp();
      saveState();

      // clear minimal
      payName.value = "";
      payFee.value = "";
      if(payBank) payBank.value = "";
      if(payAccount) payAccount.value = "";
      // keep subject for fast entry
      showToast("ê²°ì œ í•­ëª© ì¶”ê°€");
      renderAll();
    });

    mkAddBtn.addEventListener("click", () => {
      if(state.settings.locked) return;

      const academyId = mkAcademy.value || "";
      const a = academyId ? findAcademyById(academyId) : null;

      const subject = normalizeSubject(mkSubject.value) || (a && a.subject) || "";
      if(!subject){
        showToast("ê³¼ëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
        return;
      }

      const status = mkStatus.value || "requested";
      const date = (mkDate.value || "").trim();
      if((status === "scheduled" || status === "done") && !date){
        showToast("í™•ì •/ì™„ë£Œ ë³´ê°•ì€ ë‚ ì§œê°€ í•„ìš”í•©ë‹ˆë‹¤");
        return;
      }
      if(date && !parseYMD(date)){
        showToast("ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
        return;
      }

      const start = (mkStart.value || "").trim();
      const end = (mkEnd.value || "").trim();
      const remindMin = safeInt(mkRemindMin.value, 0) || 0;

      makeups().push({
        id: uid(),
        academyId: academyId || null,
        subject,
        date,
        start,
        end,
        status,
        remindMin,
        memo: "",
        createdAt: nowStamp(),
        updatedAt: nowStamp()
      });
      updateProfileStamp();
      saveState();

      showToast("ë³´ê°• ì¶”ê°€");
      renderAll();
    });

    lockBtn.addEventListener("click", () => {
      state.settings.locked = !state.settings.locked;
      state.ui.anchor = null;
      saveState();
      syncControls();
      renderGrid();
      showToast(state.settings.locked ? "ì ê¸ˆ: ë³´ê¸° ì „ìš©" : "ì ê¸ˆ í•´ì œ: í¸ì§‘ ê°€ëŠ¥");
    });

    printBtn.addEventListener("click", () => {
      // ì¸ì‡„ ì „ì— ë¹„êµ ëª¨ë“œë¡œ ì „í™˜ (ì›ë³µ ê°€ëŠ¥)
      const prev = state.settings.viewMode;
      const prevScroll = {
        x: gridScroll ? gridScroll.scrollLeft : 0,
        y: gridScroll ? gridScroll.scrollTop : 0
      };

      state.settings.viewMode = "compare";
      saveState();
      syncControls();
      renderAll();
      setTimeout(() => {
        // ì¸ì‡„ í—¤ë” ê°±ì‹  + ìŠ¤í¬ë¡¤ ì›ì (ì¢Œìƒë‹¨)ìœ¼ë¡œ ë§ì¶”ê¸°
        try{
          const p = activeProfile();
          const now = new Date();
          if(printTitle){
            printTitle.textContent = `ì •ìš° í•™ì› ìŠ¤ì¼€ì¤„ Â· ${p.name} Â· ì •ê·œë°˜/ë‚´ì‹ ë°˜ ë¹„êµ`;
          }
          if(printMeta){
            printMeta.textContent = `ì¶œë ¥: ${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())} ${pad2(now.getHours())}:${pad2(now.getMinutes())} Â· (ì‹œê°„í‘œë§Œ 1ì¥ ì¶œë ¥)`;
          }
        }catch(e){ /* ignore */ }

        if(gridScroll){
          gridScroll.scrollLeft = 0;
          gridScroll.scrollTop = 0;
        }

        window.print();
        // print í›„ ë‹¤ì‹œ ì›ë³µ
        state.settings.viewMode = prev;
        saveState();
        syncControls();
        renderAll();

        // ì‚¬ìš©ì ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë„ ì›ë³µ
        setTimeout(() => {
          if(gridScroll){
            gridScroll.scrollLeft = prevScroll.x;
            gridScroll.scrollTop = prevScroll.y;
          }
        }, 0);
      }, 120);
    });

    profileSelect.addEventListener("change", () => {
      if(state.settings.locked) return;
      state.activeProfileId = profileSelect.value;
      state.ui.anchor = null;
      saveState();
      renderAll(true);
    });

    newProfileBtn.addEventListener("click", () => {
      if(state.settings.locked) return;
      const name = normalizeSubject(prompt("ìƒˆ í•™ê¸° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2í•™ê¸°)") || "");
      if(!name) return;
      const p = defaultProfile();
      p.name = name;
      // unique name not required
      state.profiles.push(p);
      state.activeProfileId = p.id;
      state.ui.anchor = null;
      saveState();
      showToast(`"${name}" ìƒì„±`);
      renderAll(true);
    });

    renameProfileBtn.addEventListener("click", () => {
      if(state.settings.locked) return;
      const p = activeProfile();
      const name = normalizeSubject(prompt("í•™ê¸° ì´ë¦„ì„ ë°”ê¿”ì£¼ì„¸ìš”", p.name) || "");
      if(!name) return;
      p.name = name;
      updateProfileStamp();
      saveState();
      renderAll(true);
    });

    deleteProfileBtn.addEventListener("click", () => {
      if(state.settings.locked) return;
      if(state.profiles.length <= 1){
        showToast("í•™ê¸°ëŠ” ìµœì†Œ 1ê°œëŠ” ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
      const p = activeProfile();
      const ok = confirm(`"${p.name}" í•™ê¸°ë¥¼ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)`);
      if(!ok) return;
      state.profiles = state.profiles.filter(x => x.id !== p.id);
      state.activeProfileId = state.profiles[0].id;
      state.ui.anchor = null;
      saveState();
      renderAll(true);
    });

    viewSeg.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-view]");
      if(!b) return;
      state.settings.viewMode = b.dataset.view;
      saveState();
      renderAll();
    });

    planSeg.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-plan]");
      if(!b) return;
      if(state.settings.locked) return;
      state.settings.activePlan = b.dataset.plan;
      state.ui.anchor = null;
      saveState();
      renderAll();
    });

    toolSeg.addEventListener("click", (e) => {
      const b = e.target.closest("button[data-tool]");
      if(!b) return;
      if(state.settings.locked) return;
      state.settings.tool = b.dataset.tool;
      state.ui.anchor = null;
      saveState();
      renderAll();
    });

    preventOverlapCb.addEventListener("change", () => {
      if(state.settings.locked) return;
      state.settings.preventOverlap = !!preventOverlapCb.checked;
      saveState();
      renderAll();
    });

    autoColorCb.addEventListener("change", () => {
      if(state.settings.locked) return;
      state.settings.autoColor = !!autoColorCb.checked;
      // apply auto color to current subject
      const subj = normalizeSubject(state.ui.subject);
      if(subj && state.settings.autoColor && isValidSubjectName(subj)){
        const c = getSubjectColor(subj) || autoPickColor(subj);
        state.ui.color = c;
        colorPicker.value = c;
        if(!getSubjectColor(subj)) setSubjectColor(subj, c);
      }
      saveState();
      renderAll();
    });

    // IME(í•œê¸€) ì¡°í•© ì¤‘ì—ëŠ” input ì´ë²¤íŠ¸ê°€ ì—¬ëŸ¬ ë²ˆ ë°œìƒí•˜ë©´ì„œ
    // "ã„±/êµ¬/êµ­/ìˆ˜í•˜" ê°™ì€ ì¤‘ê°„ê°’ì´ ê³¼ëª© ë¦¬ìŠ¤íŠ¸(ì¹©)ë¡œ ì €ì¥ë  ìˆ˜ ìˆë‹¤.
    // composition ì´ë²¤íŠ¸ë¡œ ì¡°í•© ì¤‘ ìƒíƒœë¥¼ ê°ì§€í•´ì„œ, ì¡°í•©ì´ ëë‚œ ë’¤ì—ë§Œ ê³¼ëª© ìƒ‰ìƒ/ì¹© ë°ì´í„°ì— ë°˜ì˜í•œë‹¤.
    subjectInput.addEventListener("compositionstart", () => {
      subjectComposing = true;
    });
    subjectInput.addEventListener("compositionend", () => {
      subjectComposing = false;
      if(state.settings.locked) return;
      state.ui.subject = subjectInput.value;

      const subj = normalizeSubject(state.ui.subject);
      if(subj && state.settings.autoColor && isValidSubjectName(subj)){
        const c = getSubjectColor(subj) || autoPickColor(subj);
        state.ui.color = c;
        colorPicker.value = c;
        if(!getSubjectColor(subj)) setSubjectColor(subj, c);
      }
      state.ui.anchor = null;
      saveState();
      renderAll();
    });

    subjectInput.addEventListener("input", (e) => {
      if(state.settings.locked) return;
      state.ui.subject = subjectInput.value;

      // ì¡°í•© ì¤‘ì—ëŠ” ì €ì¥/ì¹© ì—…ë°ì´íŠ¸ë¥¼ í•˜ì§€ ì•ŠìŒ
      if(subjectComposing || (e && e.isComposing)){
        state.ui.anchor = null;
        saveState();
        return;
      }

      const subj = normalizeSubject(state.ui.subject);
      if(subj && state.settings.autoColor && isValidSubjectName(subj)){
        const c = getSubjectColor(subj) || autoPickColor(subj);
        state.ui.color = c;
        colorPicker.value = c;
        if(!getSubjectColor(subj)) setSubjectColor(subj, c);
      }
      state.ui.anchor = null;
      saveState();
      renderAll();
    });

    colorPicker.addEventListener("input", () => {
      if(state.settings.locked) return;
      state.ui.color = colorPicker.value;
      // if subject exists, assign to subject mapping (manual)
      const subj = normalizeSubject(state.ui.subject);
      if(subj){
        setSubjectColor(subj, state.ui.color);
      }
      saveState();
      renderAll();
    });

    // ESC clears anchor (desktop)
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        state.ui.anchor = null;
        saveState();
        renderAll();
      }
    });

    // ====== Service Worker ======
    if("serviceWorker" in navigator){
      window.addEventListener("load", async () => {
        try{
          const reg = await navigator.serviceWorker.register("./sw.js");
          // update toast
          reg.addEventListener("updatefound", () => {
            const sw = reg.installing;
            if(!sw) return;
            sw.addEventListener("statechange", () => {
              if(sw.state === "installed" && navigator.serviceWorker.controller){
                showToast("ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤", "ìƒˆë¡œê³ ì¹¨", () => location.reload());
              }
            });
          });
        }catch(err){
          console.warn("sw register failed", err);
        }
      });
    }

    // ====== Render all ======
    function renderAll(rebuild=false){
      if(rebuild){
        cellMap.clear();
      }
      // palette selection highlight
      for(const b of paletteEl.querySelectorAll("button.colorbtn")){
        b.classList.toggle("on", b.dataset.color === state.ui.color);
      }

      syncControls();
      renderKpiBar();
      updateNotifHint();

      const tab = state.settings.tab || "timetable";
      if(tab === "timetable"){
        buildSubjectChips();
        renderGrid();
        renderLists();
      }
      if(tab === "payments"){
        renderPayments();
      }
      if(tab === "makeup"){
        renderMakeups();
      }
    }

    // ====== Init ======
    buildPalette();
    populatePayDayOptions();
    refreshAcademySelect();
    updateNotifHint();
    startReminderTicker();
    renderAll(true);

  })();
  </script>
</body>
</html>
